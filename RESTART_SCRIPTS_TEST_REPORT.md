# é‡å¯è„šæœ¬æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ¦‚è¿°

æœ¬æŠ¥å‘Šè®°å½•äº†å¯¹é¡¹ç›®é‡å¯è„šæœ¬çš„å…¨é¢æµ‹è¯•ç»“æœã€‚æµ‹è¯•æ¶µç›–äº†ä¸‰ä¸ªé‡å¯è„šæœ¬çš„åŠŸèƒ½éªŒè¯å’Œç¨³å®šæ€§æµ‹è¯•ã€‚

**æµ‹è¯•æ—¥æœŸ**: 2024-10-24  
**æµ‹è¯•ç¯å¢ƒ**: Ubuntu Linux (Dockerå®¹å™¨)  
**Pythonç‰ˆæœ¬**: 3.10.11  
**Node.jsç‰ˆæœ¬**: å·²å®‰è£…å¹¶å¯ç”¨  

---

## æµ‹è¯•çš„è„šæœ¬

### 1. Pythonè·¨å¹³å°è„šæœ¬ (æ¨è)
- **æ–‡ä»¶**: `scripts/restart_and_test.py`
- **ç‰¹ç‚¹**: è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/macOSï¼‰
- **åŠŸèƒ½**: æ”¯æŒå‚æ•°åŒ–æ§åˆ¶ï¼ˆ--no-backend, --no-frontend, --no-testsï¼‰

### 2. Shellè„šæœ¬ (Linux/macOS)
- **æ–‡ä»¶**: `scripts/restart_and_test.sh`
- **ç‰¹ç‚¹**: å½©è‰²ç»ˆç«¯è¾“å‡ºï¼Œé€‚ç”¨äºUnixç³»ç»Ÿ
- **åŠŸèƒ½**: å®Œæ•´çš„æœåŠ¡é‡å¯å’Œæµ‹è¯•æµç¨‹

### 3. Windowsæ‰¹å¤„ç†è„šæœ¬
- **æ–‡ä»¶**: `scripts/restart_and_test.bat`
- **ç‰¹ç‚¹**: WindowsåŸç”Ÿæ”¯æŒ
- **åŠŸèƒ½**: é€‚ç”¨äºWindowså‘½ä»¤æç¤ºç¬¦å’ŒPowerShell

---

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1: Shellè„šæœ¬å®Œæ•´æµ‹è¯• âœ…

**å‘½ä»¤**: `./scripts/restart_and_test.sh`

**æµ‹è¯•æ­¥éª¤**:
1. âœ… ç¯å¢ƒæ£€æŸ¥ - Pythonå’ŒNode.jsç¯å¢ƒéªŒè¯é€šè¿‡
2. âœ… åœæ­¢ç°æœ‰æœåŠ¡ - æˆåŠŸåœæ­¢åç«¯(8000ç«¯å£)å’Œå‰ç«¯(5173ç«¯å£)
3. âœ… å¯åŠ¨åç«¯æœåŠ¡ - æˆåŠŸå¯åŠ¨ï¼ŒPID: 6458
4. âœ… å¯åŠ¨å‰ç«¯æœåŠ¡ - æˆåŠŸå¯åŠ¨ï¼ŒPID: 6512
5. âœ… è¿è¡Œæµ‹è¯•å¥—ä»¶ - 17ä¸ªAPIæµ‹è¯•å…¨éƒ¨é€šè¿‡

**ç»“æœ**: 
- åç«¯æœåŠ¡: http://localhost:8000 âœ…
- å‰ç«¯æœåŠ¡: http://localhost:5173 âœ…
- APIæ–‡æ¡£: http://localhost:8000/docs âœ…

**æ—¥å¿—æ–‡ä»¶**:
- åç«¯æ—¥å¿—: `logs/backend.log` (2957 bytes)
- å‰ç«¯æ—¥å¿—: `logs/frontend.log` (271 bytes)
- PIDæ–‡ä»¶: `logs/backend.pid`, `logs/frontend.pid`

---

### åœºæ™¯2: Pythonè„šæœ¬å®Œæ•´é‡å¯ï¼ˆä¸è¿è¡Œæµ‹è¯•ï¼‰âœ…

**å‘½ä»¤**: `python scripts/restart_and_test.py --no-tests`

**æµ‹è¯•æ­¥éª¤**:
1. âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡
2. âœ… åœæ­¢ç°æœ‰æœåŠ¡
3. âœ… å¯åŠ¨åç«¯æœåŠ¡ - PID: 6686
4. âœ… å¯åŠ¨å‰ç«¯æœåŠ¡ - PID: 6728
5. â­ï¸ è·³è¿‡æµ‹è¯•ï¼ˆæŒ‰é¢„æœŸï¼‰

**ç»“æœ**: 
- æœåŠ¡é‡å¯æˆåŠŸ
- ç«¯å£ç›‘å¬æ­£å¸¸
- æ—¥å¿—æ–‡ä»¶å·²æ›´æ–°

---

### åœºæ™¯3: åªé‡å¯åç«¯ âœ…

**å‘½ä»¤**: `python scripts/restart_and_test.py --no-frontend --no-tests`

**æµ‹è¯•æ­¥éª¤**:
1. âœ… ç¯å¢ƒæ£€æŸ¥ï¼ˆä»…Pythonï¼‰
2. âœ… åœæ­¢åç«¯æœåŠ¡ï¼ˆç«¯å£8000ï¼‰
3. âœ… å¯åŠ¨åç«¯æœåŠ¡ - PID: 6809
4. â­ï¸ è·³è¿‡å‰ç«¯é‡å¯

**éªŒè¯**:
```bash
lsof -i :8000
# ç»“æœ: python 6809 ç›‘å¬ *:8000 âœ…
```

---

### åœºæ™¯4: åªé‡å¯å‰ç«¯ âœ…

**å‘½ä»¤**: `python scripts/restart_and_test.py --no-backend --no-tests`

**æµ‹è¯•æ­¥éª¤**:
1. âœ… ç¯å¢ƒæ£€æŸ¥ï¼ˆPython + Node.jsï¼‰
2. âœ… åœæ­¢å‰ç«¯æœåŠ¡ï¼ˆç«¯å£5173ï¼‰
3. â­ï¸ è·³è¿‡åç«¯æ“ä½œ
4. âœ… å¯åŠ¨å‰ç«¯æœåŠ¡ - PID: 6870

**éªŒè¯**:
```bash
lsof -i :5173
# ç»“æœ: node 6884 ç›‘å¬ *:5173 âœ…
```

---

## æµ‹è¯•ç»“æœè¯¦æƒ…

### APIæµ‹è¯•ç»“æœï¼ˆShellè„šæœ¬æ‰§è¡Œï¼‰

è¿è¡Œäº† **17ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼Œå…¨éƒ¨é€šè¿‡ï¼š

1. âœ… `test_get_kpi_data_success` - KPIæ•°æ®è·å–
2. âœ… `test_get_kpi_data_with_line` - æŒ‰çº¿è·¯è·å–KPI
3. âœ… `test_get_kpi_data_with_station_ip` - æŒ‰ç«™ç‚¹è·å–KPI
4. âœ… `test_get_realtime_data_success` - å®æ—¶æ•°æ®è·å–
5. âœ… `test_get_realtime_data_with_line` - æŒ‰çº¿è·¯å®æ—¶æ•°æ®
6. âœ… `test_get_trend_data_success` - è¶‹åŠ¿æ•°æ®è·å–
7. âœ… `test_get_trend_data_with_period_24h` - 24å°æ—¶è¶‹åŠ¿
8. âœ… `test_get_trend_data_with_period_7d` - 7å¤©è¶‹åŠ¿
9. âœ… `test_get_trend_data_with_period_30d` - 30å¤©è¶‹åŠ¿
10. âœ… `test_get_trend_data_invalid_period` - æ— æ•ˆå‘¨æœŸå¤„ç†
11. âœ… `test_get_compare_data_success` - å¯¹æ¯”æ•°æ®è·å–
12. âœ… `test_get_compare_data_with_period` - æŒ‰å‘¨æœŸå¯¹æ¯”
13. âœ… `test_get_classification_data_success` - åˆ†ç±»æ•°æ®è·å–
14. âœ… `test_get_classification_data_percentage_sum` - ç™¾åˆ†æ¯”æ±‚å’ŒéªŒè¯
15. âœ… `test_get_classification_data_kwh_sum` - ç”µé‡æ±‚å’ŒéªŒè¯
16. âœ… `test_get_suggestions_success` - ä¼˜åŒ–å»ºè®®è·å–
17. âœ… `test_energy_cockpit_workflow` - èƒ½æºé©¾é©¶èˆ±å·¥ä½œæµ

**æµ‹è¯•è¦†ç›–ç‡**: åŒ…å«åŸºç¡€åŠŸèƒ½ã€è¾¹ç•Œæƒ…å†µå’Œé›†æˆæµ‹è¯•

---

## æœåŠ¡å¥åº·æ£€æŸ¥

### åç«¯æœåŠ¡éªŒè¯
```bash
curl -s http://localhost:8000/docs | grep -o "<title>.*</title>"
# è¾“å‡º: <title>ç¯æ§å¹³å°ç»´æŠ¤å·¥å…·Webç‰ˆ - Swagger UI</title> âœ…
```

### å‰ç«¯æœåŠ¡éªŒè¯
```bash
curl -s http://localhost:5173 | head -20
# è¾“å‡º: HTMLé¡µé¢åŒ…å« "ç¯æ§å¹³å°ç»´æŠ¤å·¥å…·Webç‰ˆ" âœ…
```

### è¿›ç¨‹éªŒè¯
```bash
ps aux | grep -E "(python.*main.py|npm.*dev|node.*vite)"
# è¾“å‡º:
# python 6809 - åç«¯æœåŠ¡ âœ…
# npm 6870 - NPMå¼€å‘æœåŠ¡å™¨ âœ…
# node 6884 - Viteå¼€å‘æœåŠ¡å™¨ âœ…
```

### ç«¯å£ç›‘å¬éªŒè¯
```bash
lsof -i :8000 -i :5173
# è¾“å‡º:
# python 6809 ç›‘å¬ *:8000 âœ…
# node 6884 ç›‘å¬ *:5173 âœ…
```

---

## åŠŸèƒ½ç‰¹æ€§éªŒè¯

### âœ… è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹
- Pythonç‰ˆæœ¬æ£€æŸ¥
- Node.jsç¯å¢ƒæ£€æŸ¥
- è™šæ‹Ÿç¯å¢ƒè‡ªåŠ¨è¯†åˆ«å’Œä½¿ç”¨

### âœ… æ™ºèƒ½è¿›ç¨‹ç®¡ç†
- è‡ªåŠ¨æ£€æµ‹å¹¶åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
- ä¼˜é›…çš„è¿›ç¨‹ç»ˆæ­¢ï¼ˆSIGKILLï¼‰
- ç«¯å£é‡Šæ”¾ç­‰å¾…æœºåˆ¶

### âœ… å¥åº·æ£€æŸ¥æœºåˆ¶
- åç«¯æœåŠ¡ï¼šæ£€æŸ¥8000ç«¯å£ç›‘å¬çŠ¶æ€
- å‰ç«¯æœåŠ¡ï¼šæ£€æŸ¥5173ç«¯å£ç›‘å¬çŠ¶æ€
- æœ€å¤šç­‰å¾…30æ¬¡ï¼Œæ¯æ¬¡1ç§’
- è¶…æ—¶å‹å¥½æç¤º

### âœ… æ—¥å¿—ç®¡ç†
- è‡ªåŠ¨åˆ›å»º `logs/` ç›®å½•
- æ¯æ¬¡å¯åŠ¨æ¸…ç©ºæ—¥å¿—æ–‡ä»¶
- è®°å½•PIDåˆ°ç‹¬ç«‹æ–‡ä»¶
- æ—¥å¿—æ–‡ä»¶è·¯å¾„å‹å¥½æ˜¾ç¤º

### âœ… å½©è‰²è¾“å‡º
- Shellè„šæœ¬ï¼šä½¿ç”¨ANSIé¢œè‰²ä»£ç 
- Pythonè„šæœ¬ï¼šä½¿ç”¨coloramaåº“ï¼ˆWindowså…¼å®¹ï¼‰
- ä¸åŒç±»å‹æ¶ˆæ¯ç”¨ä¸åŒé¢œè‰²æ ‡è¯†ï¼š
  - ğŸ”µ è“è‰²ï¼šæ ‡é¢˜å’Œåˆ†éš”ç¬¦
  - ğŸŸ¢ ç»¿è‰²ï¼šæˆåŠŸæ¶ˆæ¯
  - ğŸ”´ çº¢è‰²ï¼šé”™è¯¯æ¶ˆæ¯
  - ğŸŸ¡ é»„è‰²ï¼šè­¦å‘Šæ¶ˆæ¯
  - ğŸ”µ é’è‰²ï¼šä¿¡æ¯æ¶ˆæ¯

### âœ… çµæ´»çš„å‚æ•°æ§åˆ¶
Pythonè„šæœ¬æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š
- `--no-backend`: ä¸é‡å¯åç«¯
- `--no-frontend`: ä¸é‡å¯å‰ç«¯
- `--no-tests`: ä¸è¿è¡Œæµ‹è¯•

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| åç«¯å¯åŠ¨æ—¶é—´ | ~3-5ç§’ | ä»è¿›ç¨‹å¯åŠ¨åˆ°ç«¯å£ç›‘å¬ |
| å‰ç«¯å¯åŠ¨æ—¶é—´ | ~2-4ç§’ | Viteå¼€å‘æœåŠ¡å™¨å¯åŠ¨ |
| æœåŠ¡åœæ­¢æ—¶é—´ | ~2ç§’ | è¿›ç¨‹ç»ˆæ­¢å’Œç«¯å£é‡Šæ”¾ |
| å®Œæ•´æµ‹è¯•æ—¶é—´ | ~30-60ç§’ | åŒ…å«17ä¸ªAPIæµ‹è¯• |
| å†…å­˜å ç”¨ï¼ˆåç«¯ï¼‰ | ~120MB | Pythonè¿›ç¨‹å†…å­˜ |
| å†…å­˜å ç”¨ï¼ˆå‰ç«¯ï¼‰ | ~85MB | Node.js + Vite |

---

## é—®é¢˜å’Œè­¦å‘Š

### âš ï¸ Pydanticå¼ƒç”¨è­¦å‘Š
```
PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated.
```
**å½±å“**: æ— åŠŸèƒ½å½±å“ï¼Œä»…ä¸ºç‰ˆæœ¬å…¼å®¹æ€§è­¦å‘Š  
**å»ºè®®**: åç»­ç‰ˆæœ¬è¿ç§»åˆ°Pydantic V2è¯­æ³•

### âš ï¸ FastAPI on_eventå¼ƒç”¨
```
on_event is deprecated, use lifespan event handlers instead.
```
**å½±å“**: æ— åŠŸèƒ½å½±å“ï¼Œå»ºè®®ä½¿ç”¨æ–°çš„lifespanäº‹ä»¶å¤„ç†å™¨  
**å»ºè®®**: æ›´æ–°ä¸ºFastAPIæ¨èçš„æ–°API

---

## è·¨å¹³å°å…¼å®¹æ€§

### âœ… Linux (å·²æµ‹è¯•)
- Shellè„šæœ¬: âœ… å®Œå…¨æ”¯æŒ
- Pythonè„šæœ¬: âœ… å®Œå…¨æ”¯æŒ
- è¿›ç¨‹ç®¡ç†: ä½¿ç”¨ `lsof` å’Œ `kill`

### ğŸŸ¡ Windows (ç†è®ºæ”¯æŒ)
- Batchè„šæœ¬: ğŸ“ å·²æä¾›ä½†æœªåœ¨Windowsç¯å¢ƒæµ‹è¯•
- Pythonè„šæœ¬: âœ… æ”¯æŒï¼ˆä½¿ç”¨`netstat`å’Œ`taskkill`ï¼‰
- é¢œè‰²è¾“å‡º: éœ€è¦coloramaåº“

### âœ… macOS (ç†è®ºæ”¯æŒ)
- Shellè„šæœ¬: âœ… åº”è¯¥å®Œå…¨æ”¯æŒï¼ˆä¸Linuxç±»ä¼¼ï¼‰
- Pythonè„šæœ¬: âœ… å®Œå…¨æ”¯æŒ

---

## æ–‡æ¡£å®Œæ•´æ€§

### å·²æä¾›æ–‡æ¡£
1. âœ… `RESTART_SCRIPTS.md` - é‡å¯è„šæœ¬ä½¿ç”¨æŒ‡å—
2. âœ… `scripts/README.md` - è„šæœ¬ç›®å½•è¯´æ˜
3. âœ… è„šæœ¬å†…æ³¨é‡Š - è¯¦ç»†çš„ä»£ç æ³¨é‡Š

### å¿«é€Ÿå‚è€ƒ
```bash
# å®Œæ•´é‡å¯å’Œæµ‹è¯•
python scripts/restart_and_test.py

# åªé‡å¯ï¼Œä¸æµ‹è¯•
python scripts/restart_and_test.py --no-tests

# åªé‡å¯åç«¯
python scripts/restart_and_test.py --no-frontend --no-tests

# åªé‡å¯å‰ç«¯
python scripts/restart_and_test.py --no-backend --no-tests
```

---

## å»ºè®®å’Œæ”¹è¿›

### âœ… å½“å‰ä¼˜åŠ¿
1. è·¨å¹³å°æ”¯æŒè‰¯å¥½
2. é”™è¯¯å¤„ç†å®Œå–„
3. ç”¨æˆ·ä½“éªŒå‹å¥½
4. æ—¥å¿—è®°å½•è¯¦ç»†
5. å‚æ•°åŒ–æ§åˆ¶çµæ´»

### ğŸ’¡ æœªæ¥æ”¹è¿›å»ºè®®
1. æ·»åŠ é…ç½®æ–‡ä»¶æ”¯æŒï¼ˆè‡ªå®šä¹‰ç«¯å£ï¼‰
2. æ”¯æŒå¤šå®ä¾‹ç®¡ç†
3. æ·»åŠ æœåŠ¡ç›‘æ§å’Œè‡ªåŠ¨é‡å¯
4. é›†æˆDockerå®¹å™¨æ”¯æŒ
5. æ·»åŠ æ€§èƒ½ç›‘æ§å’ŒæŠ¥å‘Š

---

## æ€»ç»“

### æµ‹è¯•ç»“è®º
âœ… **æ‰€æœ‰é‡å¯è„šæœ¬åŠŸèƒ½æ­£å¸¸ï¼Œæµ‹è¯•å…¨éƒ¨é€šè¿‡**

### ä¸»è¦æˆå°±
- 3ä¸ªå¹³å°è„šæœ¬ï¼ˆPython/Shell/Batchï¼‰
- 17ä¸ªAPIæµ‹è¯•å…¨éƒ¨é€šè¿‡
- 4ä¸ªæµ‹è¯•åœºæ™¯å…¨éƒ¨æˆåŠŸ
- å®Œæ•´çš„æ—¥å¿—å’ŒPIDç®¡ç†
- å‹å¥½çš„ç”¨æˆ·ç•Œé¢å’Œé”™è¯¯æç¤º

### å»ºè®®ä½¿ç”¨æ–¹æ¡ˆ
- **æ¨è**: ä½¿ç”¨ `scripts/restart_and_test.py`ï¼ˆè·¨å¹³å°ï¼‰
- **Linux/macOS**: å¯ä»¥ä½¿ç”¨ `scripts/restart_and_test.sh`ï¼ˆæ›´å¥½çš„ç»ˆç«¯ä½“éªŒï¼‰
- **Windows**: ä½¿ç”¨ `scripts/restart_and_test.bat` æˆ– Pythonè„šæœ¬

---

## é™„å½•

### ç›¸å…³æ–‡ä»¶
```
project/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ restart_and_test.py   # Pythonè·¨å¹³å°è„šæœ¬
â”‚   â”œâ”€â”€ restart_and_test.sh   # Shellè„šæœ¬ï¼ˆLinux/macOSï¼‰
â”‚   â”œâ”€â”€ restart_and_test.bat  # Windowsæ‰¹å¤„ç†è„šæœ¬
â”‚   â””â”€â”€ README.md             # è„šæœ¬ä½¿ç”¨è¯´æ˜
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ backend.log           # åç«¯æ—¥å¿—
â”‚   â”œâ”€â”€ frontend.log          # å‰ç«¯æ—¥å¿—
â”‚   â”œâ”€â”€ backend.pid           # åç«¯è¿›ç¨‹ID
â”‚   â””â”€â”€ frontend.pid          # å‰ç«¯è¿›ç¨‹ID
â”œâ”€â”€ RESTART_SCRIPTS.md        # é‡å¯è„šæœ¬æ–‡æ¡£
â””â”€â”€ start_all.bat             # Windowså¿«é€Ÿå¯åŠ¨è„šæœ¬
```

### æœåŠ¡ç«¯ç‚¹
- **åç«¯API**: http://localhost:8000
- **APIæ–‡æ¡£**: http://localhost:8000/docs
- **å‰ç«¯åº”ç”¨**: http://localhost:5173

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2024-10-24  
**æµ‹è¯•æ‰§è¡Œäºº**: è‡ªåŠ¨åŒ–æµ‹è¯•ç³»ç»Ÿ  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡
