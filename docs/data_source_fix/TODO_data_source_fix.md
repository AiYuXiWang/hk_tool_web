# Data Source 修复功能 - 待办事项

## 🔧 需要用户处理的配置

### 1. 生产环境部署检查
- [ ] **数据库连接验证**: 确认生产环境数据库连接正常
- [ ] **表结构确认**: 验证 `bus_object_point_data` 表存在且包含必要字段
- [ ] **权限检查**: 确认应用有查询 `bus_object_point_data` 表的权限

### 2. 监控配置
- [ ] **日志监控**: 设置对 data_source 修正日志的监控告警
- [ ] **性能监控**: 监控数据库查询性能，关注响应时间变化
- [ ] **成功率监控**: 跟踪写值操作成功率的变化趋势

## 📊 数据质量检查

### 3. 数据完整性验证
- [ ] **Point Key 格式**: 确认所有点位的 `point_key` 格式统一为 `C251:设备名:点位名`
- [ ] **Data Source 值**: 检查数据库中 `data_source` 字段是否有空值或异常值
- [ ] **数据同步**: 确认点位配置与实际硬件设备保持同步

## 🚀 性能优化建议

### 4. 可选优化项
- [ ] **缓存机制**: 如果 data_source 查询频繁，考虑添加内存缓存
- [ ] **批量查询**: 对于大批量写值操作，考虑批量查询 data_source
- [ ] **索引优化**: 确认 `point_key` 字段有适当的数据库索引

## 🔍 测试验证

### 5. 生产环境测试
- [ ] **小范围测试**: 在生产环境进行小范围功能测试
- [ ] **回滚准备**: 准备快速回滚方案（如需要）
- [ ] **用户培训**: 向运维人员说明新功能的工作原理

## 📋 运维指南

### 6. 日常运维
- [ ] **日志检查**: 定期检查 data_source 修正日志，识别数据质量问题
- [ ] **性能监控**: 关注数据库查询性能，及时发现性能瓶颈
- [ ] **错误处理**: 建立 data_source 查询失败的处理流程

## 🛠️ 故障排查

### 7. 常见问题处理

#### 问题1: data_source 查询失败
**现象**: 日志中出现 "查询点位 XXX 的data_source失败"
**排查步骤**:
1. 检查数据库连接是否正常
2. 确认 point_key 在数据库中是否存在
3. 验证 point_key 格式是否正确

#### 问题2: 写值仍然失败
**现象**: data_source 已修正但写值仍失败
**排查步骤**:
1. 检查修正后的 data_source 值是否正确
2. 确认外部平台 API 是否正常
3. 验证其他写值参数是否正确

#### 问题3: 性能下降
**现象**: 写值响应时间明显增加
**排查步骤**:
1. 检查数据库查询性能
2. 确认 `point_key` 字段索引是否存在
3. 考虑添加缓存机制

## 📞 技术支持

### 8. 获取帮助
- **文档位置**: `docs/data_source_fix/`
- **测试脚本**: `test_data_source_fix.py`
- **调试脚本**: `debug_data_source.py`
- **核心代码**: `control_service.py` 中的相关方法

### 9. 联系方式
如遇到技术问题，请提供以下信息：
- 错误日志内容
- 相关 point_key 信息
- 数据库查询结果
- 系统环境信息

---

## ✅ 完成检查清单

请在完成每项任务后打勾：

**部署前检查**:
- [ ] 数据库连接测试通过
- [ ] 权限验证完成
- [ ] 小范围功能测试通过

**部署后验证**:
- [ ] 监控配置完成
- [ ] 日志记录正常
- [ ] 性能指标正常

**运维准备**:
- [ ] 故障排查流程建立
- [ ] 运维人员培训完成
- [ ] 回滚方案准备就绪

*完成以上检查清单后，data_source 自动修复功能即可正式投入生产使用。*