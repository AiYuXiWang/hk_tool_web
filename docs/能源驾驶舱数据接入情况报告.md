# 能源驾驶舱数据接入情况报告

## 报告日期
2024年

## 概述
本报告详细说明能源驾驶舱各个功能模块的后端数据接入情况，以及需要改进的地方。

## 当前数据接入情况

### ❌ 所有接口均使用模拟数据

经过详细审查 `backend/app/api/energy_dashboard.py` 和 `backend/app/services/energy_service.py`，发现**所有能源驾驶舱接口目前都使用模拟数据**，没有接入真实的数据源。

## 详细接口分析

### 1. 实时能耗监控 (`/api/energy/realtime`)

**数据来源：** 模拟数据

**实现方式：**
```python
# 使用 random.uniform() 生成功率数据
base_power = random.uniform(100, 200)
if 6 <= hour <= 22:  # 白天功率较高
    power = base_power * random.uniform(0.8, 1.2)
else:  # 夜间功率较低
    power = base_power * random.uniform(0.5, 0.8)
```

**需要接入：**
- 实时设备功率数据（从设备监控系统或 IoT 平台获取）
- 实时能耗计量数据（从能耗计量系统获取）

---

### 2. 历史趋势数据 (`/api/energy/trend`, `/api/energy/history`)

**数据来源：** 模拟数据

**实现方式：**
```python
# 基于站点数量和时间用公式计算
base_value = station_count * 150  # 每站点每小时约150kWh
trend_factor = 1.0 - (i / data_points) * 0.1  # 轻微下降趋势
random_factor = random.uniform(0.85, 1.15)
value = base_value * trend_factor * random_factor
```

**需要接入：**
- 历史能耗数据库（按小时/天/月存储的真实能耗记录）
- 时序数据库（如 InfluxDB、TimescaleDB 等）

---

### 3. KPI 指标数据 (`/api/energy/kpi`)

**数据来源：** 模拟数据

**实现方式：**
```python
# 基于站点数量计算基础值
base_power_per_station = 150  # 每站点基础功率(kW)
current_kw = sum(
    base_power_per_station * (0.8 + 0.4 * random.random())
    for _ in range(station_count)
)
```

**需要接入：**
- 实时功率计量数据
- 今日累计能耗数据
- 峰值功率记录

---

### 4. 同比环比对比 (`/api/energy/compare`)

**数据来源：** 模拟数据

**实现方式：**
```python
# 模拟节能效果，一般为负值或小正值
yoy_percent = random.uniform(-15, 5)  # 同比百分比
mom_percent = random.uniform(-10, 10)  # 环比百分比
```

**需要接入：**
- 去年同期能耗数据（用于同比计算）
- 上一周期能耗数据（用于环比计算）
- 需要建立历史数据存储机制

---

### 5. 分类分项能耗 (`/api/energy/classification`)

**数据来源：** 模拟数据

**实现方式：**
```python
# 定义设备分类及其占比范围（预设值）
categories = [
    {"name": "冷机系统", "ratio_range": (0.35, 0.45)},
    {"name": "水泵系统", "ratio_range": (0.15, 0.25)},
    # ...
]
# 根据占比范围随机生成
ratio = random.uniform(category["ratio_range"][0], category["ratio_range"][1])
```

**需要接入：**
- 各类设备的能耗计量数据
- 设备分类标签信息
- 分项能耗计量表数据

---

### 6. 设备运行状态 (`/api/energy/equipment`)

**数据来源：** 模拟数据

**实现方式：**
```python
# 模拟设备状态
status_rand = random.random()
if status_rand > 0.9:
    status = "error"
elif status_rand > 0.7:
    status = "warning"
else:
    status = "normal"
```

**需要接入：**
- 设备运行状态监控系统
- 设备故障诊断系统
- 设备效率监测数据

---

### 7. 节能优化建议 (`/api/energy/suggestions`)

**数据来源：** 硬编码的建议列表

**实现方式：**
```python
# 返回固定的建议列表
suggestions = [
    {
        "id": 1,
        "title": "冷机运行时间优化",
        "description": "建议在非高峰时段降低冷机运行功率...",
        # ...
    },
    # ...
]
```

**需要接入：**
- AI 分析引擎（基于历史数据和实时数据）
- 节能算法模型
- 专家规则系统

---

## 数据接入改进建议

### 短期改进（1-2周）

1. **接入电耗计量数据库**
   - 连接现有的能耗计量系统数据库
   - 获取真实的历史能耗记录
   - 实现基本的数据查询和聚合

2. **接入设备监控数据**
   - 连接设备监控平台 API
   - 获取实时功率和运行状态
   - 实现设备列表和状态的真实展示

### 中期改进（1-2个月）

3. **建立时序数据存储**
   - 部署时序数据库（InfluxDB/TimescaleDB）
   - 建立数据采集和存储流程
   - 实现高频数据的存储和查询

4. **实现数据分析功能**
   - 开发同比环比计算逻辑
   - 实现分类分项能耗统计
   - 建立 KPI 指标计算规则

### 长期改进（3-6个月）

5. **开发 AI 分析引擎**
   - 训练能耗预测模型
   - 开发异常检测算法
   - 实现智能优化建议生成

6. **完善数据质量管理**
   - 建立数据质量监控
   - 实现数据清洗和校验
   - 建立数据备份和恢复机制

---

## 数据源清单

需要接入的数据源包括：

| 数据类型 | 数据源 | 优先级 | 状态 |
|---------|--------|--------|------|
| 实时功率数据 | 设备监控系统 | 高 | ❌ 未接入 |
| 历史能耗数据 | 能耗计量数据库 | 高 | ❌ 未接入 |
| 设备运行状态 | 设备管理系统 | 高 | ❌ 未接入 |
| 环境参数数据 | 传感器网络 | 中 | ❌ 未接入 |
| 客流量数据 | 客流统计系统 | 中 | ❌ 未接入 |
| 天气数据 | 气象服务 API | 低 | ❌ 未接入 |
| 电价数据 | 电力公司系统 | 低 | ❌ 未接入 |

---

## 技术实施建议

### 1. 数据库连接

```python
# 示例：连接能耗数据库
from sqlalchemy import create_engine
import pandas as pd

class EnergyDataSource:
    def __init__(self):
        self.engine = create_engine('mysql://user:pass@host/energy_db')
    
    def get_realtime_power(self, station_ip: str):
        query = """
        SELECT timestamp, power_kw, energy_kwh
        FROM realtime_energy
        WHERE station_ip = %s
        ORDER BY timestamp DESC
        LIMIT 100
        """
        return pd.read_sql(query, self.engine, params=[station_ip])
```

### 2. 时序数据查询

```python
# 示例：从 InfluxDB 查询时序数据
from influxdb_client import InfluxDBClient

class TimeSeriesDataSource:
    def __init__(self):
        self.client = InfluxDBClient(url="http://localhost:8086", 
                                     token="your-token", 
                                     org="your-org")
    
    def query_power_trend(self, station_ip: str, hours: int):
        query = f"""
        from(bucket: "energy")
          |> range(start: -{hours}h)
          |> filter(fn: (r) => r["station_ip"] == "{station_ip}")
          |> filter(fn: (r) => r["_measurement"] == "power")
          |> aggregateWindow(every: 1h, fn: mean)
        """
        return self.client.query_api().query(query)
```

### 3. API 集成

```python
# 示例：调用外部设备监控 API
import httpx

class DeviceMonitorAPI:
    def __init__(self, base_url: str, token: str):
        self.base_url = base_url
        self.token = token
    
    async def get_device_status(self, device_id: str):
        async with httpx.AsyncClient() as client:
            response = await client.get(
                f"{self.base_url}/devices/{device_id}/status",
                headers={"Authorization": f"Bearer {self.token}"}
            )
            return response.json()
```

---

## 数据接口标准化建议

为了便于未来的数据接入，建议定义统一的数据接口标准：

### 实时数据接口规范

```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "station_ip": "192.168.1.100",
  "station_name": "示例站",
  "metrics": {
    "current_power_kw": 450.5,
    "voltage_v": 380,
    "current_a": 680,
    "power_factor": 0.95,
    "temperature_c": 25.5
  }
}
```

### 历史数据接口规范

```json
{
  "station_ip": "192.168.1.100",
  "period": "24h",
  "data_points": [
    {
      "timestamp": "2024-01-01T00:00:00Z",
      "energy_kwh": 150.5,
      "avg_power_kw": 150.5
    }
  ]
}
```

---

## 结论

### 当前状态总结

✅ **优点：**
- 接口结构清晰，易于理解
- 模拟数据格式完整，为真实数据接入提供了良好的模板
- 错误处理机制完善

❌ **问题：**
- **所有数据均为模拟数据，未接入真实数据源**
- 无法反映真实的能耗情况和设备状态
- 无法支持实际的运维决策和节能分析

### 行动建议

**立即行动：**
1. 明确真实数据源的位置和访问方式
2. 建立数据库连接和 API 集成
3. 逐步替换模拟数据为真实数据

**持续改进：**
1. 建立数据质量监控机制
2. 优化数据查询性能
3. 完善数据分析和可视化功能

---

## 附录：需要的配置信息

为了接入真实数据，需要以下配置信息：

- [ ] 能耗计量数据库连接信息（主机、端口、用户名、密码、数据库名）
- [ ] 设备监控系统 API 地址和认证信息
- [ ] 时序数据库配置（如使用）
- [ ] 数据采集频率和保留策略
- [ ] 数据安全和权限管理要求

---

**报告编写者：** AI Development Assistant  
**审核状态：** 待审核  
**下次更新：** 待真实数据接入后更新
