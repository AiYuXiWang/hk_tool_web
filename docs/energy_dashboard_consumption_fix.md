# èƒ½æºé©¾é©¶èˆ±èƒ½è€—æ•°æ®ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

èƒ½æºé©¾é©¶èˆ±æ˜¾ç¤ºçš„èƒ½è€—ä¿¡æ¯ä¸å®é™…ä¸ä¸€è‡´ã€‚å¯¼å‡ºåŠŸèƒ½ï¼ˆ`export_service.py`ï¼‰ä½¿ç”¨ä»¥ä¸‹é…ç½®å’Œé€»è¾‘è®¡ç®—èƒ½è€—ï¼š

- è¯»å–ç«™ç‚¹é…ç½®ä¸­çš„ `data_codes` æ•°ç»„ï¼ˆåŒ…å«æ‰€æœ‰ç”µè¡¨çš„æ•°æ®ä»£ç ï¼‰
- è¯»å–ç«™ç‚¹é…ç½®ä¸­çš„ `object_codes` æ•°ç»„ï¼ˆåŒ…å«æ‰€æœ‰è®¾å¤‡å¯¹è±¡ä»£ç ï¼‰
- è°ƒç”¨ `/data/selectHisData` API è·å–**æ‰€æœ‰è®¾å¤‡**çš„ç”µè¡¨èµ·ç ã€æ­¢ç 
- è®¡ç®—è€—ç”µé‡ = ç”µè¡¨æ­¢ç  - ç”µè¡¨èµ·ç 

ä½†èƒ½æºé©¾é©¶èˆ±ä½¿ç”¨çš„æ˜¯**åŠŸç‡ä¼°ç®—**æ–¹å¼ï¼š`æ—¥èƒ½è€— = å½“å‰åŠŸç‡ Ã— 20å°æ—¶`ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. åœ¨ `RealtimeEnergyService` ä¸­æ·»åŠ èƒ½è€—è®¡ç®—æ–¹æ³•

**æ–‡ä»¶**: `backend/app/services/realtime_energy_service.py`

#### æ–°å¢æ–¹æ³•ï¼š`get_station_energy_consumption`

```python
async def get_station_energy_consumption(
    self, station: Dict[str, Any], start_time: datetime, end_time: datetime
) -> Optional[float]:
    """
    è·å–å•ä¸ªç«™ç‚¹åœ¨æŒ‡å®šæ—¶é—´æ®µçš„èƒ½è€—
    
    ä½¿ç”¨ä¸export_service.pyä¸­process_dataå‡½æ•°ç›¸åŒçš„é€»è¾‘ï¼š
    1. è·å–æ—¶é—´æ®µå¼€å§‹æ—¶çš„ç”µè¡¨è¯»æ•°ï¼ˆèµ·ç ï¼‰
    2. è·å–æ—¶é—´æ®µç»“æŸæ—¶çš„ç”µè¡¨è¯»æ•°ï¼ˆæ­¢ç ï¼‰
    3. è®¡ç®—å·®å€¼ä½œä¸ºè€—ç”µé‡
    """
```

è¯¥æ–¹æ³•ï¼š
- ä½¿ç”¨ç«™ç‚¹çš„ `data_codes` å’Œ `object_codes` é…ç½®
- è°ƒç”¨ `/data/selectHisData` API è·å–ç”µè¡¨è¯»æ•°
- æŒ‰ç…§ `export_service.py` çš„ `process_data` å‡½æ•°å®Œå…¨ç›¸åŒçš„é€»è¾‘è®¡ç®—èƒ½è€—

#### æ–°å¢æ–¹æ³•ï¼š`_calculate_consumption_from_meter_readings`

```python
async def _calculate_consumption_from_meter_readings(
    self,
    api_url: str,
    object_codes: List[str],
    data_codes: List[str],
    start_time: datetime,
    end_time: datetime,
    station_name: str = "æœªçŸ¥ç«™ç‚¹"
) -> Optional[float]:
    """
    æ ¹æ®ç”µè¡¨èµ·ç å’Œæ­¢ç è®¡ç®—èƒ½è€—
    
    è¿™ä¸ªæ–¹æ³•å®Œå…¨å¤åˆ¶export_service.pyä¸­process_dataå‡½æ•°çš„é€»è¾‘
    """
```

è¯¥æ–¹æ³•å®ç°äº†ä¸ `export_service.py` å®Œå…¨ä¸€è‡´çš„é€»è¾‘ï¼š

1. **è·å–ç»“æŸæ—¶é—´çš„ç”µè¡¨è¯»æ•°ï¼ˆæ­¢ç ï¼‰**
   ```python
   end_obj = {
       "dataCodes": data_codes,
       "endTime": end_timestamp,
       "fill": "0",
       "funcName": "mean",
       "funcTime": "",
       "measurement": "realData",
       "objectCodes": object_codes,
       "startTime": end_timestamp - 10 * 60000  # 10åˆ†é’Ÿå‰
   }
   ```

2. **è·å–å¼€å§‹æ—¶é—´çš„ç”µè¡¨è¯»æ•°ï¼ˆèµ·ç ï¼‰**
   ```python
   start_obj = {
       "dataCodes": data_codes,
       "endTime": start_timestamp + 3 * 60000,  # 3åˆ†é’Ÿå
       "fill": "0",
       "funcName": "mean",
       "funcTime": "",
       "measurement": "realData",
       "objectCodes": object_codes,
       "startTime": start_timestamp
   }
   ```

3. **è®¡ç®—æ¯ä¸ªè®¾å¤‡çš„èƒ½è€—å¹¶æ±‡æ€»**
   ```python
   for data_code in data_codes:
       for object_code in object_codes:
           # æŸ¥æ‰¾åŒ¹é…çš„èµ·å§‹å’Œç»“æŸè¯»æ•°
           start_entry = next(...)
           end_entry = next(...)
           
           if start_entry and end_entry:
               start_reading = float(start_values[0].get("value"))
               end_reading = float(end_values[0].get("value"))
               
               # è®¡ç®—èƒ½è€—å·®å€¼ï¼ˆå‚è€ƒexport_service.pyç¬¬226-229è¡Œï¼‰
               if end_reading - start_reading >= -1:
                   consumption = end_reading - start_reading
                   total_consumption += consumption
               else:
                   # ç”µè¡¨å¼‚å¸¸
                   logger.warning("ç”µè¡¨å¼‚å¸¸")
   ```

### 2. ä¿®æ”¹ `EnergyService` ä½¿ç”¨æ–°çš„èƒ½è€—è®¡ç®—æ–¹æ³•

**æ–‡ä»¶**: `backend/app/services/energy_service.py`

#### ä¿®æ”¹æ–¹æ³•ï¼š`_get_station_overview_data`

**ä¿®æ”¹å‰**ï¼ˆä½¿ç”¨åŠŸç‡ä¼°ç®—ï¼‰ï¼š
```python
# è®¡ç®—æ—¥èƒ½è€—ï¼ˆåŸºäºå½“å‰åŠŸç‡çš„ä¼°ç®—ï¼Œä¸å†å åŠ éšæœºå› ç´ ï¼‰
daily_consumption = current_power * 20  # å‡è®¾å¹³å‡è¿è¡Œ20å°æ—¶/å¤©
```

**ä¿®æ”¹å**ï¼ˆä½¿ç”¨ç”µè¡¨è¯»æ•°è®¡ç®—ï¼‰ï¼š
```python
# è®¡ç®—æ—¥èƒ½è€—ï¼šä½¿ç”¨ä¸export_serviceç›¸åŒçš„é€»è¾‘
# è·å–å½“å¤©çš„å®é™…èƒ½è€—ï¼ˆä»å½“å¤©00:00åˆ°ç°åœ¨çš„ç”µè¡¨è¯»æ•°å·®å€¼ï¼‰
now = datetime.now()
start_of_day = now.replace(hour=0, minute=0, second=0, microsecond=0)

daily_consumption = await self.realtime_service.get_station_energy_consumption(
    station, start_of_day, now
)

# å¦‚æœæ— æ³•è·å–çœŸå®èƒ½è€—ï¼Œä½¿ç”¨åŠŸç‡ä¼°ç®—ï¼ˆå‘åå…¼å®¹ï¼‰
if daily_consumption is None:
    daily_consumption = current_power * 20  # å‡è®¾å¹³å‡è¿è¡Œ20å°æ—¶/å¤©
    if data_source == "real":
        data_source = "partial"  # æœ‰åŠŸç‡ä½†æ— èƒ½è€—æ•°æ®
        self.logger.warning(
            "âš ï¸ [%s] èƒ½è€—æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨åŠŸç‡ä¼°ç®—: %.2f kWh",
            station_name,
            daily_consumption,
        )
else:
    self.logger.info(
        "âœ… [%s] æˆåŠŸè·å–çœŸå®æ—¥èƒ½è€—: %.2f kWh (ä½¿ç”¨ç”µè¡¨è¯»æ•°è®¡ç®—)",
        station_name,
        daily_consumption,
    )
```

## ä¿®å¤éªŒè¯

### æµ‹è¯•æ–‡ä»¶

åˆ›å»ºäº†å…¨é¢çš„æµ‹è¯•æ–‡ä»¶ `tests/test_energy_dashboard_consumption_fix.py`ï¼ŒéªŒè¯ï¼š

1. âœ… æ–°å¢çš„èƒ½è€—è®¡ç®—æ–¹æ³•å­˜åœ¨
2. âœ… ä½¿ç”¨æ­£ç¡®çš„é…ç½®ï¼ˆ`data_codes` å’Œ `object_codes` æ•°ç»„ï¼‰
3. âœ… èƒ½è€—è®¡ç®—é€»è¾‘ä¸ `export_service.py` ä¸€è‡´
4. âœ… ç”µè¡¨è¯»æ•°è§£æå’Œå¼‚å¸¸å¤„ç†æ­£ç¡®
5. âœ… APIè¯·æ±‚æ ¼å¼ä¸ `export_service` ä¸€è‡´
6. âœ… é…ç½®ä¸å¯¼å‡ºæœåŠ¡ä¿æŒä¸€è‡´

### æµ‹è¯•ç»“æœ

```bash
$ python tests/test_energy_dashboard_consumption_fix.py

======================================================================
èƒ½æºé©¾é©¶èˆ±èƒ½è€—è®¡ç®—ä¿®å¤æµ‹è¯•
======================================================================

âœ“ èƒ½è€—è®¡ç®—æ–¹æ³•å­˜åœ¨

âœ“ èƒ½è€—è®¡ç®—ä½¿ç”¨æ­£ç¡®çš„é…ç½®ï¼ˆdata_codeså’Œobject_codesæ•°ç»„ï¼‰
  - data_codesæ•°é‡: 17
  - object_codesæ•°é‡: 13

âœ“ èƒ½è€—è®¡ç®—é€»è¾‘æ­£ç¡®: 130.0 kWh
  - ä½¿ç”¨ç”µè¡¨èµ·ç ã€æ­¢ç å·®å€¼è®¡ç®—
  - LSA1_28: 50 kWh (1050 - 1000)
  - LSA2_28: 80 kWh (2080 - 2000)

âœ“ APIè¯·æ±‚payloadä¸export_serviceä¸€è‡´
  - ç¬¬ä¸€æ¬¡è¯·æ±‚: ç»“æŸæ—¶é—´çª—å£ 1704109800000 ~ 1704110400000
  - ç¬¬äºŒæ¬¡è¯·æ±‚: å¼€å§‹æ—¶é—´çª—å£ 1704067200000 ~ 1704067380000

âœ“ ç”µè¡¨è¯»æ•°è§£æå’Œå¼‚å¸¸å¤„ç†æ­£ç¡®

âœ“ APIè¯·æ±‚æ ¼å¼ä¸export_serviceä¸€è‡´
  - ç»“æŸæ—¶é—´çª—å£: endTime å¾€å‰10åˆ†é’Ÿ
  - å¼€å§‹æ—¶é—´çª—å£: startTime å¾€å3åˆ†é’Ÿ
  - funcName: mean
  - fill: 0

âœ“ è‹—å²­è·¯: é…ç½®ä¸export_serviceä¸€è‡´
  - data_codesæ•°é‡: 17
  - object_codesæ•°é‡: 13

âœ“ æŒ¯åè·¯: é…ç½®ä¸export_serviceä¸€è‡´
  - data_codesæ•°é‡: 24
  - object_codesæ•°é‡: 9

âœ“ äº”å››å¹¿åœº: é…ç½®ä¸export_serviceä¸€è‡´
  - data_codesæ•°é‡: 28
  - object_codesæ•°é‡: 5

======================================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
======================================================================

ä¿®å¤æ€»ç»“ï¼š
1. âœ“ èƒ½æºé©¾é©¶èˆ±ä½¿ç”¨data_codeså’Œobject_codesé…ç½®
2. âœ“ ä½¿ç”¨ç”µè¡¨èµ·ç ã€æ­¢ç å·®å€¼è®¡ç®—èƒ½è€—
3. âœ“ ä¸export_service.pyçš„process_dataå‡½æ•°é€»è¾‘ä¸€è‡´
4. âœ“ è°ƒç”¨/data/selectHisData APIè·å–æ•°æ®
5. âœ“ æ­£ç¡®å¤„ç†ç”µè¡¨å¼‚å¸¸æƒ…å†µ
```

## æ•°æ®ä¸€è‡´æ€§ä¿è¯

### ç›¸åŒçš„é…ç½®æº

- **å¯¼å‡ºåŠŸèƒ½**: ä» `config_electricity.line_configs[line][station]` è¯»å– `data_codes` å’Œ `object_codes`
- **èƒ½æºé©¾é©¶èˆ±**: ä»åŒä¸€é…ç½®æºè¯»å–ç›¸åŒçš„ `data_codes` å’Œ `object_codes`

### ç›¸åŒçš„APIè°ƒç”¨

ä¸¤è€…éƒ½è°ƒç”¨ç›¸åŒçš„APIï¼š`http://{station_ip}:9898/data/selectHisData`

### ç›¸åŒçš„è®¡ç®—é€»è¾‘

1. è·å–ç»“æŸæ—¶é—´çš„ç”µè¡¨è¯»æ•°ï¼ˆåœ¨ç»“æŸæ—¶é—´å‰10åˆ†é’Ÿçª—å£å†…å–å¹³å‡ï¼‰
2. è·å–å¼€å§‹æ—¶é—´çš„ç”µè¡¨è¯»æ•°ï¼ˆåœ¨å¼€å§‹æ—¶é—´å3åˆ†é’Ÿçª—å£å†…å–å¹³å‡ï¼‰
3. å¯¹æ¯ä¸ª `data_code`ï¼Œéå†æ‰€æœ‰ `object_code` æ‰¾åˆ°åŒ¹é…çš„æ•°æ®
4. è®¡ç®—å·®å€¼ï¼ˆæ­¢ç  - èµ·ç ï¼‰ä½œä¸ºè€—ç”µé‡
5. å¦‚æœå·®å€¼ < -1ï¼Œè®¤ä¸ºæ˜¯ç”µè¡¨å¼‚å¸¸ï¼Œè·³è¿‡è¯¥è®¾å¤‡

## å‘åå…¼å®¹æ€§

å¦‚æœæ— æ³•è·å–ç”µè¡¨è¯»æ•°ï¼ˆä¾‹å¦‚ï¼šAPIä¸å¯è¾¾ã€é…ç½®ç¼ºå¤±ã€æ•°æ®ä¸ºç©ºï¼‰ï¼Œç³»ç»Ÿä¼šå›é€€åˆ°åŠŸç‡ä¼°ç®—æ–¹å¼ï¼š

```python
if daily_consumption is None:
    daily_consumption = current_power * 20  # å‡è®¾å¹³å‡è¿è¡Œ20å°æ—¶/å¤©
```

è¿™ç¡®ä¿äº†åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ç³»ç»Ÿä»èƒ½æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯æ•°æ®ç²¾åº¦ä¼šé™ä½ã€‚

## é…ç½®è¦æ±‚

æ¯ä¸ªç«™ç‚¹çš„é…ç½®å¿…é¡»åŒ…å«ï¼š

```python
line_configs = {
    "M11": {
        "è‹—å²­è·¯": {
            "ip": "192.168.1.100",
            "station": "è‹—å²­è·¯",
            "data_codes": [  # æ‰€æœ‰ç”µè¡¨çš„æ•°æ®ä»£ç 
                "LSA1_28", "LSA2_28", "LT/A1_7", "LT/A2_7",
                # ... æ›´å¤šè®¾å¤‡
            ],
            "object_codes": [  # æ‰€æœ‰è®¾å¤‡å¯¹è±¡ä»£ç 
                "OBJ001", "OBJ002", "OBJ003",
                # ... æ›´å¤šå¯¹è±¡
            ],
            "data_list": [  # è®¾å¤‡è¯¦ç»†ä¿¡æ¯
                {"p1": 1, "p2": "ç«™ç«¯åŒºåŸŸ", "p3": "è®¾å¤‡åç§°", ...},
                # ... æ›´å¤šè®¾å¤‡
            ],
            "jienengfeijieneng": {  # ä»…ç”¨äºèŠ‚èƒ½çŠ¶æ€æŸ¥è¯¢
                "data_codes": ["JNFJN_1"],
                "object_codes": ["OBJ_JNFJN"]
            }
        }
    }
}
```

**é‡è¦è¯´æ˜**ï¼š
- `data_codes` å’Œ `object_codes` æ•°ç»„ç”¨äºèƒ½è€—è®¡ç®—ï¼ˆè·å–æ‰€æœ‰è®¾å¤‡çš„ç”µè¡¨è¯»æ•°ï¼‰
- `jienengfeijieneng` èŠ‚ç‚¹ä»…ç”¨äºèŠ‚èƒ½çŠ¶æ€æŸ¥è¯¢ï¼ˆ1ä¸ªdata_codeè¡¨ç¤ºèŠ‚èƒ½/éèŠ‚èƒ½çŠ¶æ€ï¼‰

## æ—¥å¿—è®°å½•

ä¿®å¤åçš„ä»£ç æä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§ï¼š

```
ğŸ“Š [è‹—å²­è·¯] å¼€å§‹è·å–æ€»è§ˆæ•°æ® - è®¾å¤‡æ•°é‡: 17
ğŸ“Š [è‹—å²­è·¯] å¼€å§‹è·å–ç«™ç‚¹èƒ½è€— - ç«™ç‚¹: è‹—å²­è·¯, IP: 192.168.1.100, çº¿è·¯: M11, æ—¶é—´æ®µ: 2024-01-01 00:00:00 ~ 2024-01-01 12:00:00
ğŸ“Š [è‹—å²­è·¯] è®¾å¤‡ LSA1_28/OBJ001: èµ·ç =1000.00, æ­¢ç =1050.00, è€—ç”µ=50.00 kWh
ğŸ“Š [è‹—å²­è·¯] è®¾å¤‡ LSA2_28/OBJ001: èµ·ç =2000.00, æ­¢ç =2080.00, è€—ç”µ=80.00 kWh
ğŸ“Š [è‹—å²­è·¯] èƒ½è€—è®¡ç®—å®Œæˆ - æœ‰æ•ˆè®¾å¤‡æ•°: 17/17, æ€»èƒ½è€—: 1250.00 kWh
âœ… [è‹—å²­è·¯] æˆåŠŸè·å–çœŸå®æ—¥èƒ½è€—: 1250.00 kWh (ä½¿ç”¨ç”µè¡¨è¯»æ•°è®¡ç®—)
âœ… [è‹—å²­è·¯] æ€»è§ˆæ•°æ®è·å–æˆåŠŸ - å½“å‰åŠŸç‡: 85.50 kW, æ—¥èƒ½è€—: 1250.00 kWh
```

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¿®å¤ï¼Œèƒ½æºé©¾é©¶èˆ±çš„èƒ½è€—æ•°æ®è®¡ç®—é€»è¾‘ä¸å¯¼å‡ºåŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼Œç¡®ä¿äº†æ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚ä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

1. **æ•°æ®æºä¸€è‡´**: éƒ½ä½¿ç”¨ `data_codes` å’Œ `object_codes` é…ç½®
2. **APIè°ƒç”¨ä¸€è‡´**: éƒ½è°ƒç”¨ `/data/selectHisData` æ¥å£
3. **è®¡ç®—é€»è¾‘ä¸€è‡´**: éƒ½ä½¿ç”¨ç”µè¡¨èµ·ç ã€æ­¢ç å·®å€¼è®¡ç®—èƒ½è€—
4. **å¼‚å¸¸å¤„ç†ä¸€è‡´**: éƒ½æ­£ç¡®å¤„ç†ç”µè¡¨å¼‚å¸¸æƒ…å†µï¼ˆå·®å€¼ < -1ï¼‰
5. **å‘åå…¼å®¹**: åœ¨æ— æ³•è·å–çœŸå®æ•°æ®æ—¶å›é€€åˆ°åŠŸç‡ä¼°ç®—

è¿™ç¡®ä¿äº†èƒ½æºé©¾é©¶èˆ±æ˜¾ç¤ºçš„èƒ½è€—æ•°æ®ä¸å¯¼å‡ºæŠ¥è¡¨ä¸­çš„æ•°æ®å®Œå…¨ä¸€è‡´ã€‚
