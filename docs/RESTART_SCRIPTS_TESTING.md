# é‡å¯è„šæœ¬æµ‹è¯•æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†å¯¹é¡¹ç›®é‡å¯è„šæœ¬çš„å®Œæ•´æµ‹è¯•è¿‡ç¨‹å’Œç»“æœã€‚æµ‹è¯•ç›®æ ‡æ˜¯éªŒè¯æ‰€æœ‰é‡å¯è„šæœ¬åœ¨ä¸åŒåœºæ™¯ä¸‹çš„åŠŸèƒ½æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚

## æµ‹è¯•è„šæœ¬

é¡¹ç›®åŒ…å«ä¸‰ä¸ªé‡å¯è„šæœ¬ï¼Œæ”¯æŒä¸åŒæ“ä½œç³»ç»Ÿï¼š

### 1. Pythonè„šæœ¬ï¼ˆæ¨è - è·¨å¹³å°ï¼‰
- **è·¯å¾„**: `scripts/restart_and_test.py`
- **ç‰¹ç‚¹**: è·¨å¹³å°å…¼å®¹ï¼Œæ”¯æŒå‚æ•°åŒ–é…ç½®
- **ä¾èµ–**: Python 3.8+

### 2. Shellè„šæœ¬ï¼ˆLinux/macOSï¼‰
- **è·¯å¾„**: `scripts/restart_and_test.sh`
- **ç‰¹ç‚¹**: å½©è‰²è¾“å‡ºï¼ŒUnixåŸç”Ÿæ”¯æŒ
- **ä¾èµ–**: Bash shell

### 3. Windowsæ‰¹å¤„ç†è„šæœ¬
- **è·¯å¾„**: `scripts/restart_and_test.bat`
- **ç‰¹ç‚¹**: WindowsåŸç”Ÿæ”¯æŒ
- **ä¾èµ–**: Windowså‘½ä»¤æç¤ºç¬¦æˆ–PowerShell

## æµ‹è¯•ç¯å¢ƒ

- **æ“ä½œç³»ç»Ÿ**: Ubuntu Linux (Dockerå®¹å™¨)
- **Pythonç‰ˆæœ¬**: 3.10.11
- **Node.js**: å·²å®‰è£…
- **æµ‹è¯•æ—¥æœŸ**: 2024-10-24

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1: å®Œæ•´é‡å¯æµç¨‹æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: Shellè„šæœ¬

**æ‰§è¡Œå‘½ä»¤**:
```bash
./scripts/restart_and_test.sh
```

**æµ‹è¯•æ­¥éª¤**:
1. ç¯å¢ƒæ£€æŸ¥ï¼ˆPythonã€Node.jsï¼‰
2. åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆåç«¯ç«¯å£8000ã€å‰ç«¯ç«¯å£5173ï¼‰
3. å¯åŠ¨åç«¯æœåŠ¡
4. å¯åŠ¨å‰ç«¯æœåŠ¡
5. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- åç«¯æˆåŠŸå¯åŠ¨ï¼ŒPID: 6458
- å‰ç«¯æˆåŠŸå¯åŠ¨ï¼ŒPID: 6512
- 17ä¸ªAPIæµ‹è¯•å…¨éƒ¨é€šè¿‡
- æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡

---

### åœºæ™¯2: Pythonè„šæœ¬å¿«é€Ÿé‡å¯

**æµ‹è¯•è„šæœ¬**: Pythonè„šæœ¬

**æ‰§è¡Œå‘½ä»¤**:
```bash
python scripts/restart_and_test.py --no-tests
```

**æµ‹è¯•ç›®æ ‡**: éªŒè¯å¿«é€Ÿé‡å¯åŠŸèƒ½ï¼ˆè·³è¿‡æµ‹è¯•ï¼‰

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- åç«¯æˆåŠŸå¯åŠ¨ï¼ŒPID: 6686
- å‰ç«¯æˆåŠŸå¯åŠ¨ï¼ŒPID: 6728
- è·³è¿‡æµ‹è¯•é˜¶æ®µï¼ˆç¬¦åˆé¢„æœŸï¼‰
- æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡

---

### åœºæ™¯3: å•ç‹¬é‡å¯åç«¯

**æ‰§è¡Œå‘½ä»¤**:
```bash
python scripts/restart_and_test.py --no-frontend --no-tests
```

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç‹¬ç«‹é‡å¯åç«¯çš„èƒ½åŠ›

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- æˆåŠŸåœæ­¢åç«¯æœåŠ¡
- æˆåŠŸå¯åŠ¨åç«¯æœåŠ¡ï¼ŒPID: 6809
- å‰ç«¯æœåŠ¡æœªå—å½±å“
- ç«¯å£8000éªŒè¯é€šè¿‡

---

### åœºæ™¯4: å•ç‹¬é‡å¯å‰ç«¯

**æ‰§è¡Œå‘½ä»¤**:
```bash
python scripts/restart_and_test.py --no-backend --no-tests
```

**æµ‹è¯•ç›®æ ‡**: éªŒè¯ç‹¬ç«‹é‡å¯å‰ç«¯çš„èƒ½åŠ›

**æµ‹è¯•ç»“æœ**: âœ… é€šè¿‡
- æˆåŠŸåœæ­¢å‰ç«¯æœåŠ¡
- æˆåŠŸå¯åŠ¨å‰ç«¯æœåŠ¡ï¼ŒPID: 6870
- åç«¯æœåŠ¡æœªå—å½±å“
- ç«¯å£5173éªŒè¯é€šè¿‡

---

## APIæµ‹è¯•è¯¦æƒ…

### æµ‹è¯•è¦†ç›–

åœ¨å®Œæ•´æµ‹è¯•æ¨¡å¼ä¸‹ï¼Œè¿è¡Œäº†ä»¥ä¸‹æµ‹è¯•å¥—ä»¶ï¼š

#### 1. èƒ½æºKPI APIæµ‹è¯•
- âœ… test_get_kpi_data_success
- âœ… test_get_kpi_data_with_line
- âœ… test_get_kpi_data_with_station_ip

#### 2. å®æ—¶æ•°æ®APIæµ‹è¯•
- âœ… test_get_realtime_data_success
- âœ… test_get_realtime_data_with_line

#### 3. è¶‹åŠ¿æ•°æ®APIæµ‹è¯•
- âœ… test_get_trend_data_success
- âœ… test_get_trend_data_with_period_24h
- âœ… test_get_trend_data_with_period_7d
- âœ… test_get_trend_data_with_period_30d
- âœ… test_get_trend_data_invalid_period

#### 4. å¯¹æ¯”æ•°æ®APIæµ‹è¯•
- âœ… test_get_compare_data_success
- âœ… test_get_compare_data_with_period

#### 5. åˆ†ç±»æ•°æ®APIæµ‹è¯•
- âœ… test_get_classification_data_success
- âœ… test_get_classification_data_percentage_sum
- âœ… test_get_classification_data_kwh_sum

#### 6. å»ºè®®APIæµ‹è¯•
- âœ… test_get_suggestions_success

#### 7. é›†æˆæµ‹è¯•
- âœ… test_energy_cockpit_workflow

### æµ‹è¯•ç»Ÿè®¡
- **æ€»æµ‹è¯•æ•°**: 17
- **é€šè¿‡**: 17 (100%)
- **å¤±è´¥**: 0
- **è·³è¿‡**: 0

---

## æœåŠ¡å¥åº·éªŒè¯

### åç«¯æœåŠ¡
**URL**: http://localhost:8000

**å¥åº·æ£€æŸ¥**:
```bash
curl -s http://localhost:8000/docs | grep -o "<title>.*</title>"
```

**ç»“æœ**: 
```html
<title>ç¯æ§å¹³å°ç»´æŠ¤å·¥å…·Webç‰ˆ - Swagger UI</title>
```
âœ… æ­£å¸¸

### å‰ç«¯æœåŠ¡
**URL**: http://localhost:5173

**å¥åº·æ£€æŸ¥**:
```bash
curl -s http://localhost:5173
```

**ç»“æœ**: HTMLé¡µé¢æ­£å¸¸åŠ è½½ï¼ŒåŒ…å«åº”ç”¨æ ‡é¢˜ âœ…

### è¿›ç¨‹æ£€æŸ¥
```bash
ps aux | grep -E "(python.*main.py|npm.*dev|node.*vite)"
```

**ç»“æœ**:
- âœ… Pythonåç«¯è¿›ç¨‹è¿è¡Œä¸­
- âœ… NPMå¼€å‘æœåŠ¡å™¨è¿è¡Œä¸­
- âœ… Viteå¼€å‘æœåŠ¡å™¨è¿è¡Œä¸­

### ç«¯å£ç›‘å¬æ£€æŸ¥
```bash
lsof -i :8000 -i :5173
```

**ç»“æœ**:
- âœ… ç«¯å£8000: Pythonè¿›ç¨‹ç›‘å¬
- âœ… ç«¯å£5173: Node.jsè¿›ç¨‹ç›‘å¬

---

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æµ‹è¯•å€¼ | è¯´æ˜ |
|------|--------|------|
| åç«¯å¯åŠ¨æ—¶é—´ | 3-5ç§’ | ä»å¯åŠ¨åˆ°ç«¯å£ç›‘å¬å°±ç»ª |
| å‰ç«¯å¯åŠ¨æ—¶é—´ | 2-4ç§’ | Viteå¼€å‘æœåŠ¡å™¨å¯åŠ¨ |
| æœåŠ¡åœæ­¢æ—¶é—´ | ~2ç§’ | è¿›ç¨‹ç»ˆæ­¢å’Œç«¯å£é‡Šæ”¾ |
| å†…å­˜å ç”¨ï¼ˆåç«¯ï¼‰ | ~120MB | Pythonè¿è¡Œæ—¶å†…å­˜ |
| å†…å­˜å ç”¨ï¼ˆå‰ç«¯ï¼‰ | ~85MB | Node.js + Viteå†…å­˜ |
| å®Œæ•´æµ‹è¯•æ—¶é—´ | 30-60ç§’ | åŒ…å«æ‰€æœ‰APIæµ‹è¯• |

---

## è„šæœ¬ç‰¹æ€§éªŒè¯

### âœ… ç¯å¢ƒæ£€æµ‹
- Pythonç‰ˆæœ¬æ£€æŸ¥
- Node.jsç¯å¢ƒæ£€æŸ¥
- è™šæ‹Ÿç¯å¢ƒè‡ªåŠ¨è¯†åˆ«

### âœ… è¿›ç¨‹ç®¡ç†
- ç«¯å£å ç”¨æ£€æµ‹
- è¿›ç¨‹è‡ªåŠ¨åœæ­¢
- PIDæ–‡ä»¶ç®¡ç†

### âœ… å¥åº·æ£€æŸ¥
- å¯åŠ¨è¶…æ—¶æ§åˆ¶ï¼ˆæœ€å¤š30ç§’ï¼‰
- ç«¯å£ç›‘å¬éªŒè¯
- æœåŠ¡å°±ç»ªç¡®è®¤

### âœ… æ—¥å¿—ç®¡ç†
- è‡ªåŠ¨åˆ›å»ºæ—¥å¿—ç›®å½•
- æ—¥å¿—æ–‡ä»¶æ¸…ç†å’Œå†™å…¥
- PIDæ–‡ä»¶è®°å½•

### âœ… ç”¨æˆ·ä½“éªŒ
- å½©è‰²ç»ˆç«¯è¾“å‡º
- è¿›åº¦å®æ—¶æ˜¾ç¤º
- é”™è¯¯å‹å¥½æç¤º
- å®Œæˆä¿¡æ¯æ€»ç»“

### âœ… å‚æ•°åŒ–æ§åˆ¶
Pythonè„šæœ¬æ”¯æŒï¼š
- `--no-backend`: è·³è¿‡åç«¯æ“ä½œ
- `--no-frontend`: è·³è¿‡å‰ç«¯æ“ä½œ
- `--no-tests`: è·³è¿‡æµ‹è¯•é˜¶æ®µ

---

## æ—¥å¿—æ–‡ä»¶

æµ‹è¯•ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶ï¼š

```
logs/
â”œâ”€â”€ backend.log         # åç«¯æœåŠ¡æ—¥å¿—
â”œâ”€â”€ frontend.log        # å‰ç«¯æœåŠ¡æ—¥å¿—
â”œâ”€â”€ backend.pid         # åç«¯è¿›ç¨‹ID
â”œâ”€â”€ frontend.pid        # å‰ç«¯è¿›ç¨‹ID
â””â”€â”€ hk_tool_*.log      # åº”ç”¨è¿è¡Œæ—¥å¿—
```

---

## é—®é¢˜è®°å½•

### å¼ƒç”¨è­¦å‘Šï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

1. **Pydantic V1è­¦å‘Š**:
   ```
   PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated.
   ```
   - **å½±å“**: æ— åŠŸèƒ½å½±å“
   - **å»ºè®®**: åç»­è¿ç§»åˆ°Pydantic V2

2. **FastAPI on_eventè­¦å‘Š**:
   ```
   on_event is deprecated, use lifespan event handlers instead.
   ```
   - **å½±å“**: æ— åŠŸèƒ½å½±å“
   - **å»ºè®®**: ä½¿ç”¨æ–°çš„lifespan API

---

## ç»“è®º

### æµ‹è¯•é€šè¿‡ç‡
- **æµ‹è¯•åœºæ™¯é€šè¿‡ç‡**: 4/4 (100%)
- **APIæµ‹è¯•é€šè¿‡ç‡**: 17/17 (100%)
- **æœåŠ¡å¥åº·æ£€æŸ¥**: å…¨éƒ¨é€šè¿‡

### æ€»ä½“è¯„ä»·
âœ… **æ‰€æœ‰é‡å¯è„šæœ¬åŠŸèƒ½æ­£å¸¸ï¼Œæµ‹è¯•å…¨éƒ¨é€šè¿‡**

### æ¨èä½¿ç”¨
1. **è·¨å¹³å°å¼€å‘**: ä½¿ç”¨ `scripts/restart_and_test.py`
2. **Linux/macOS**: ä½¿ç”¨ `scripts/restart_and_test.sh`ï¼ˆæ›´å¥½çš„è§†è§‰ä½“éªŒï¼‰
3. **Windows**: ä½¿ç”¨ `scripts/restart_and_test.bat` æˆ– Pythonè„šæœ¬

---

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [å¿«é€Ÿä½¿ç”¨æŒ‡å—](../RESTART_SCRIPTS_QUICK_GUIDE.md)
- ğŸ“Š [è¯¦ç»†æµ‹è¯•æŠ¥å‘Š](../RESTART_SCRIPTS_TEST_REPORT.md)
- ğŸ“ [æµ‹è¯•æ‰§è¡Œæ‘˜è¦](../TEST_EXECUTION_SUMMARY.md)
- ğŸ“š [é‡å¯è„šæœ¬æ–‡æ¡£](../RESTART_SCRIPTS.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2024-10-24  
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ
