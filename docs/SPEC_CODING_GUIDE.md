# Spec Coding 开发规范

## 概述

本文档定义了项目的 Spec Coding 开发流程和规范。所有新功能开发和重要变更都必须严格遵循此规范。

## 核心原则

Spec Coding 遵循"规格先行、实现跟随"的开发理念：

1. **规格先行**：先编写详细的规格说明文档，后编写代码
2. **接口驱动**：以 API 接口和数据契约为核心设计系统
3. **可验证性**：规格说明必须是可测试、可验证的
4. **可追溯性**：代码与规格说明保持一致性和可追溯性

## 开发流程

### 1. 规格编写阶段（Specification Phase）

在开始编码之前，必须完成以下工作：

#### 1.1 创建规格说明文档

```bash
# 在 specs/ 目录下创建对应的规格文档
# 命名格式：SPEC-{模块}-{功能}-{YYYYMMDD}.md
# 例如：SPEC-ENERGY-DASHBOARD-20250101.md
```

#### 1.2 规格说明必须包含的内容

- **功能概述**：功能的目的、业务价值和使用场景
- **技术规格**：
  - API 接口定义（请求/响应格式）
  - 数据模型设计
  - 业务逻辑流程
  - 错误处理机制
- **前端规格**（如适用）：
  - 组件接口定义
  - 状态管理设计
  - 用户交互流程
- **非功能性需求**：
  - 性能要求
  - 安全要求
  - 可用性要求
- **验收标准**：明确的、可测试的验收条件

#### 1.3 规格评审

- 规格文档完成后，需要进行团队评审
- 评审通过后，规格文档冻结，进入实现阶段
- 规格变更必须经过正式的变更流程

### 2. 实现阶段（Implementation Phase）

#### 2.1 严格按照规格实现

- API 接口必须与规格说明完全一致
- 数据模型必须与规格定义完全一致
- 业务逻辑必须遵循规格描述的流程

#### 2.2 实现过程中的注意事项

- 不得偏离规格说明的设计
- 发现规格问题时，应暂停实现，先修订规格
- 保持代码与规格的同步性

#### 2.3 代码注释要求

```python
# 在关键代码处添加规格引用注释
# Spec: SPEC-ENERGY-DASHBOARD-20250101.md#section-3.2
# 功能说明：获取设备实时能耗数据
```

### 3. 验证阶段（Verification Phase）

#### 3.1 规格一致性检查

- 使用自动化工具验证 API 接口与规格的一致性
- 检查数据模型是否符合规格定义
- 验证业务逻辑是否满足规格要求

#### 3.2 单元测试

- 每个规格点必须对应至少一个单元测试
- 测试用例应直接引用规格说明

```python
def test_get_device_energy_data():
    """
    Test Spec: SPEC-ENERGY-DASHBOARD-20250101.md#section-3.2
    验证获取设备实时能耗数据接口
    """
    # 测试代码
```

#### 3.3 集成测试

- 验证端到端的功能流程
- 确保所有组件按规格说明协同工作

#### 3.4 验收测试

- 按照规格说明中的验收标准进行验收测试
- 所有验收标准必须全部通过

## 目录结构

```
project/
├── specs/                          # 规格说明文档目录
│   ├── backend/                    # 后端规格
│   │   ├── api/                    # API 规格
│   │   ├── services/               # 服务规格
│   │   └── models/                 # 数据模型规格
│   ├── frontend/                   # 前端规格
│   │   ├── views/                  # 页面规格
│   │   ├── components/             # 组件规格
│   │   └── stores/                 # 状态管理规格
│   ├── integration/                # 集成规格
│   └── templates/                  # 规格模板
├── docs/                           # 项目文档
│   ├── SPEC_CODING_GUIDE.md       # 本文档
│   └── ...
└── tests/                          # 测试代码
    ├── spec_validation/            # 规格验证测试
    └── ...
```

## 规格文档命名规范

### 命名格式

```
SPEC-{类型}-{模块}-{功能}-{日期}.md
```

### 示例

- `SPEC-API-ENERGY-REALTIME-DATA-20250101.md` - 能源实时数据 API 规格
- `SPEC-SERVICE-EXPORT-BATCH-20250101.md` - 批量导出服务规格
- `SPEC-COMPONENT-DEVICE-TREE-20250101.md` - 设备树组件规格
- `SPEC-VIEW-ENERGY-DASHBOARD-20250101.md` - 能源驾驶舱页面规格

### 类型标识

- **API**：API 接口规格
- **SERVICE**：服务层规格
- **MODEL**：数据模型规格
- **COMPONENT**：前端组件规格
- **VIEW**：前端页面规格
- **STORE**：状态管理规格
- **INTEGRATION**：集成功能规格

## 规格文档版本管理

### 版本号规则

```
v{主版本}.{次版本}.{修订版本}
```

- **主版本**：不兼容的重大变更
- **次版本**：向下兼容的功能新增
- **修订版本**：向下兼容的问题修正

### 版本历史记录

每个规格文档必须包含版本历史：

```markdown
## 版本历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| v1.0.0 | 2025-01-01 | 张三 | 初始版本 |
| v1.1.0 | 2025-01-15 | 李四 | 新增错误码定义 |
```

## 规格变更流程

### 变更请求

1. 创建变更请求文档：`SPEC-CHANGE-{编号}-{日期}.md`
2. 说明变更原因、影响范围、解决方案
3. 提交团队评审

### 变更评审

- 评估变更的必要性和合理性
- 分析变更的影响范围
- 确定变更的优先级

### 变更实施

- 更新规格文档（增加版本号）
- 更新相关代码实现
- 更新测试用例
- 更新文档

## API 规格规范

### API 规格必须包含

1. **接口基本信息**
   - 接口路径
   - 请求方法
   - 认证要求
   - 权限要求

2. **请求规格**
   - 请求头
   - 路径参数
   - 查询参数
   - 请求体（JSON Schema）

3. **响应规格**
   - 响应状态码
   - 响应头
   - 响应体（JSON Schema）

4. **错误处理**
   - 错误码定义
   - 错误消息格式
   - 异常场景处理

5. **示例**
   - 请求示例
   - 响应示例
   - 错误响应示例

### API 规格示例

参考 `specs/templates/API_SPEC_TEMPLATE.md`

## 数据模型规格规范

### 数据模型必须包含

1. **模型定义**
   - 字段名称
   - 数据类型
   - 是否必填
   - 默认值
   - 约束条件
   - 字段说明

2. **关系定义**
   - 关联关系
   - 外键约束
   - 级联操作

3. **索引定义**
   - 索引字段
   - 索引类型
   - 唯一性约束

4. **业务规则**
   - 数据验证规则
   - 数据转换规则
   - 数据生命周期

### 数据模型规格示例

参考 `specs/templates/MODEL_SPEC_TEMPLATE.md`

## 前端组件规格规范

### 组件规格必须包含

1. **组件基本信息**
   - 组件名称
   - 组件用途
   - 依赖组件

2. **Props 定义**
   - 属性名称
   - 属性类型
   - 是否必填
   - 默认值
   - 属性说明

3. **Events 定义**
   - 事件名称
   - 事件参数
   - 触发时机
   - 事件说明

4. **Slots 定义**（如适用）
   - 插槽名称
   - 插槽说明

5. **状态管理**
   - 内部状态
   - 计算属性
   - 方法

6. **样式规格**
   - CSS 类名
   - 主题变量
   - 响应式设计

### 组件规格示例

参考 `specs/templates/COMPONENT_SPEC_TEMPLATE.md`

## 工具和自动化

### 规格验证工具

```bash
# 验证 API 规格与实现的一致性
python tools/validate_api_spec.py

# 验证数据模型规格与实现的一致性
python tools/validate_model_spec.py

# 验证前端组件规格与实现的一致性
npm run validate:spec
```

### 规格生成工具

```bash
# 从现有代码生成规格草稿
python tools/generate_spec_draft.py --module energy --type api

# 从规格生成测试用例模板
python tools/generate_test_template.py --spec SPEC-API-ENERGY-REALTIME-DATA-20250101.md
```

### CI/CD 集成

在持续集成流程中加入规格验证：

```yaml
# .github/workflows/spec-validation.yml
- name: Validate Specifications
  run: |
    python tools/validate_all_specs.py
```

## 最佳实践

### 1. 规格编写建议

- **明确性**：使用精确、无歧义的语言
- **完整性**：覆盖所有场景，包括边界情况和异常情况
- **可测试性**：规格应该是可验证的
- **可读性**：使用图表、示例等增强可读性

### 2. 规格与代码同步

- 代码变更时，同步更新规格文档
- 规格文档应与代码放在同一个版本控制仓库
- 使用 Git 钩子自动检查规格一致性

### 3. 规格评审清单

- [ ] 功能描述是否清晰完整？
- [ ] API 接口定义是否明确？
- [ ] 数据模型设计是否合理？
- [ ] 错误处理是否完善？
- [ ] 验收标准是否可测试？
- [ ] 性能要求是否明确？
- [ ] 安全考虑是否充分？

### 4. 代码实现清单

- [ ] 是否严格按照规格实现？
- [ ] 是否添加了规格引用注释？
- [ ] 是否编写了对应的测试用例？
- [ ] 是否更新了相关文档？
- [ ] 是否通过了规格验证工具的检查？

## 常见问题

### Q1: 规格文档太长，写不完怎么办？

A: 可以采用迭代的方式，先完成核心规格，然后逐步完善细节。但核心的 API 接口和数据模型必须在编码前完成。

### Q2: 实现过程中发现规格有问题怎么办？

A: 应该暂停实现，提交规格变更请求，评审通过后再继续实现。不要在实现中擅自偏离规格。

### Q3: 如何确保规格与代码保持一致？

A: 使用自动化工具进行验证，并在 CI/CD 流程中强制执行。同时，在代码评审时，也要检查是否符合规格。

### Q4: 小的 bug 修复也需要规格吗？

A: 简单的 bug 修复不需要完整的规格文档，但应该在相关的规格文档中记录修改说明。

## 参考资源

- [API 规格模板](../specs/templates/API_SPEC_TEMPLATE.md)
- [数据模型规格模板](../specs/templates/MODEL_SPEC_TEMPLATE.md)
- [组件规格模板](../specs/templates/COMPONENT_SPEC_TEMPLATE.md)
- [规格变更模板](../specs/templates/SPEC_CHANGE_TEMPLATE.md)

## 附录

### 术语表

- **Spec**：规格说明文档
- **Specification**：规格、规范
- **Contract**：契约、接口定义
- **Schema**：数据结构定义
- **Acceptance Criteria**：验收标准

### 相关标准

- [OpenAPI Specification](https://swagger.io/specification/)
- [JSON Schema](https://json-schema.org/)
- [TypeScript Type Definition](https://www.typescriptlang.org/docs/handbook/declaration-files/introduction.html)

---

**最后更新**: 2025-01-01  
**维护者**: 开发团队  
**版本**: v1.0.0
