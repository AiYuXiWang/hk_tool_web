# 自动化验证工具使用说明

## 概述

本项目提供了两套自动化验证工具，用于确保Web版本与桌面端版本的功能一致性：
1. 文件对比工具 - 对比两个版本导出文件的一致性
2. 一致性验证工具 - 验证两个版本功能逻辑的一致性

## 1. 文件对比工具

### 1.1 工具说明

文件对比工具用于对比桌面端和Web端导出文件的一致性，支持Excel和CSV格式文件的对比。

### 1.2 使用方法

```bash
python validation/compare_files.py <desktop_dir> <web_dir> [-o output_file]
```

参数说明：
- `desktop_dir`：桌面端导出文件目录
- `web_dir`：Web端导出文件目录
- `-o output_file`：输出报告文件路径（可选，默认为comparison_report.txt）

### 1.3 使用示例

```bash
# 对比两个目录下的文件
python validation/compare_files.py ./desktop_exports ./web_exports

# 指定输出报告文件
python validation/compare_files.py ./desktop_exports ./web_exports -o my_report.txt
```

### 1.4 输出报告说明

报告内容包括：
- 对比的目录信息
- 文件数量统计
- 每个文件的对比结果
- 差异详情（如适用）
- 总体一致性结论

## 2. 一致性验证工具

### 2.1 工具说明

一致性验证工具用于验证桌面端和Web端在功能逻辑上的一致性，包括配置读取、API调用、数据处理等方面。

### 2.2 使用方法

```bash
python validation/validate_consistency.py <line_name> <start_time> <end_time> [-o output_file]
```

参数说明：
- `line_name`：线路名称（如"M3"）
- `start_time`：开始时间（格式：YYYY-MM-DD HH:MM:SS）
- `end_time`：结束时间（格式：YYYY-MM-DD HH:MM:SS）
- `-o output_file`：输出报告文件路径（可选，默认为validation_report.txt）

### 2.3 使用示例

```bash
# 验证M3线路的一致性
python validation/validate_consistency.py M3 "2025-01-01 00:00:00" "2025-01-02 00:00:00"

# 指定输出报告文件
python validation/validate_consistency.py M3 "2025-01-01 00:00:00" "2025-01-02 00:00:00" -o m3_validation.txt
```

### 2.4 输出报告说明

报告内容包括：
- 验证的线路和时间范围信息
- 电耗导出功能验证结果
- API调用一致性验证结果
- 数据处理逻辑一致性验证结果
- 总体一致性结论

## 3. 集成到持续集成流程

### 3.1 自动化测试脚本

可以创建一个自动化测试脚本来执行完整的验证流程：

```bash
#!/bin/bash
# auto_test.sh

echo "开始自动化验证流程"

# 设置测试参数
LINE_NAME="M3"
START_TIME="2025-01-01 00:00:00"
END_TIME="2025-01-02 00:00:00"
DESKTOP_DIR="./desktop_test"
WEB_DIR="./web_test"

echo "1. 执行桌面端导出测试"
# 这里调用桌面端导出功能（需要根据实际情况实现）
# python app_export.py --test-mode --line $LINE_NAME --start "$START_TIME" --end "$END_TIME" --output $DESKTOP_DIR

echo "2. 执行Web端导出测试"
# 这里调用Web端导出功能（需要根据实际情况实现）
# curl -X POST "http://localhost:8000/api/export/electricity" -H "Content-Type: application/json" -d "{\"line\":\"$LINE_NAME\",\"start_time\":\"$START_TIME\",\"end_time\":\"$END_TIME\"}"

echo "3. 执行文件对比验证"
python validation/compare_files.py $DESKTOP_DIR $WEB_DIR -o file_comparison_report.txt

echo "4. 执行一致性逻辑验证"
python validation/validate_consistency.py $LINE_NAME "$START_TIME" "$END_TIME" -o consistency_validation_report.txt

echo "自动化验证流程完成"
```

### 3.2 在CI/CD中使用

可以在CI/CD流程中添加验证步骤：

```yaml
# .github/workflows/validate.yml
name: 功能一致性验证
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: 设置Python环境
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: 安装依赖
      run: |
        pip install -r requirements.txt
    - name: 启动后端服务
      run: |
        python main.py &
        sleep 10
    - name: 执行一致性验证
      run: |
        python validation/validate_consistency.py M3 "2025-01-01 00:00:00" "2025-01-02 00:00:00"
    - name: 上传验证报告
      uses: actions/upload-artifact@v2
      with:
        name: validation-report
        path: validation_report.txt
```

## 4. 验证工具开发说明

### 4.1 文件对比工具扩展

如果需要支持更多文件格式，可以扩展 [compare_files.py](file:///d%3A/Project2025/qoder/hk_tool_web/validation/compare_files.py) 中的对比方法：

```python
def compare_pdf_files(self, desktop_file: str, web_file: str) -> Dict:
    """对比两个PDF文件的内容"""
    # 实现PDF文件对比逻辑
    pass

def compare_json_files(self, desktop_file: str, web_file: str) -> Dict:
    """对比两个JSON文件的内容"""
    # 实现JSON文件对比逻辑
    pass
```

### 4.2 一致性验证工具扩展

如果需要验证更多功能模块，可以扩展 [validate_consistency.py](file:///d%3A/Project2025/qoder/hk_tool_web/validation/validate_consistency.py) 中的验证方法：

```python
def validate_new_feature(self, line_name: str, start_time: datetime, end_time: datetime) -> Dict:
    """验证新功能的一致性"""
    # 实现新功能验证逻辑
    pass
```

## 5. 最佳实践

### 5.1 定期验证

建议定期执行自动化验证，确保Web版本与桌面端版本保持一致：

```bash
# 每周执行一次全面验证
0 0 * * 0 python validation/validate_consistency.py M3 "2025-01-01 00:00:00" "2025-01-02 00:00:00"
```

### 5.2 版本发布前验证

在每次版本发布前，务必执行完整的自动化验证：

```bash
# 版本发布前验证脚本
#!/bin/bash
echo "执行版本发布前验证"
python validation/validate_consistency.py M3 "2025-01-01 00:00:00" "2025-01-02 00:00:00" -o pre_release_validation.txt
python validation/compare_files.py ./desktop_sample ./web_sample -o pre_release_comparison.txt
echo "版本发布前验证完成"
```

## 结论

通过使用自动化验证工具，可以确保Web版本与桌面端版本在功能上保持一致，及时发现和解决可能的差异问题。建议将这些工具集成到开发和部署流程中，以保证项目的长期维护质量。