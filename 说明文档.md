# 环控节能平台设备点位运维与批量控制模块

## 背景与目标
- 背景：现有项目已提供数据导出能力，但缺乏对“设备点位”的运维与批量控制功能，影响日常节能策略下发与状态监控效率。
- 目标：
  - 提供设备树浏览、点位实时值查询、批量写值控制与容错重试。
  - 实时显示执行进度和反馈状态，异常站点红标提示。
  - 建立操作日志审计闭环（时间戳、操作员ID、前后值）。
  - 预留模板配置、定时任务、WebSocket 推送等扩展能力。

## 技术方案
- 后端：FastAPI（Python 3.10.11），封装环控节能平台 API
  - 实时查询：GET /api/busObjectInfo/selectInfObjectByCode（参数：object_code、data_code；服务端注入 token）
  - 批量写值：POST /api/objectPointInfo/writePointValue（数组：point_key、data_source、control_value）
  - 认证：固定 token 仅保存在服务端配置，前端不直传秘钥；OpenAPI 使用 apiKey in header 描述
  - 并发策略：异步并发、部分失败不中断；失败重试（指数退避2^n，最多3次）；写入前做类型/范围校验
  - 审计：写库（操作日志表）、落盘日志（含请求体、响应、耗时、操作者）
  - 实时：WebSocket 推送任务进度与点位最新值（后续迭代）
- 前端：Vue3 + Element Plus + Vite
  - 页面：设备总览（树+点位表+对比+红标）、批量控制台（进度条/重试）、操作日志、模板与定时任务、告警与健康
  - 实时：WebSocket 客户端订阅站点/设备
- 数据库：MySQL（复用现有连接），新增表建议
  - operation_log(id, operator_id, object_code, data_code, before_value, after_value, result, message, created_at, duration_ms)
  - alarm_event(id, level, object_code, data_code, value, rule, message, created_at)
- 安全与合规
  - 固定 Token 不入库、不前端暴露；配置注入
  - 速率限制/熔断（后续迭代）；入参严格校验与审计

## 进度看板
- 里程碑（遵循 2S 顺序化流程）：
  - [x] 需求与方案对齐（本文件）
  - [x] OpenAPI 文档（docs/openapi/control-module.yaml）
  - [ ] 单元测试（后端接口契约、校验、并发与容错，覆盖率≥90%）
  - [ ] 实现代码（后端路由/服务、前端页面与组件）
  - [ ] 本地自测（pytest 全绿）
  - [ ] git commit
- 计划日期（示例，可调整）：
  - OpenAPI：T+0
  - 单测：T+1
  - 实现：T+3
  - 自测：T+4
  - 提交：T+4

## 变更记录
- 2025-10-09 09:40, Webview 报错修复：移除 :has 选择器的 DOM 补丁，改为安全选择器（.el-select input / .el-date-editor input）与防御性赋值，避免 getBoundingClientRect 空引用错误。
- 2025-10-09 09:35, UI 布局重构：设备树固定在左侧，右侧划分为“点位实时值”表格与“实时写值”面板（当前选中点），优化空间利用与操作流程；保留批量写值入口。
- 2025-10-09 09:30, UI 可访问性补充：为导出表单（线路/开始/结束）添加 aria-label，扩大按钮点击区以 !important 提升覆盖优先级，降低 unlabeledInputs 与 smallTargets。
- 2025-10-09 09:25, UI 可访问性与点击面积优化：为筛选/object_code/data_code 输入增加 id+label(for)（sr-only），统一增大 .el-button--small 与 text 按钮点击区（min-height≥40px），以满足可用性复测指标。
- 2025-10-09 09:20, UI 可用性优化：提升文本对比度（#1a1a1a/#4c4c4c）、扩大按钮点击面积（min-height≥40px）、补充 aria-label（筛选/查询输入）；移除失效 favicon 链接，提升前后端联调体验。
- 2025-10-09 09:00, start_all.bat, 修正前端端口提示 3000→5173
- 2025-10-06 16:52 联调排障插桩：App.vue 在 normalizeTree 之后输出 source_len/nodes_len/样本节点，便于定位 “No Data” 根因。
- 2025-10-06 16:45 设备树渲染修复：App.vue 在 loadDeviceTree 中对返回结果执行 normalizeTree，再渲染与抽取点位元数据。
- 2025-10-06 16:28 前端联调修复：设备树节点键名映射 normalizeTree（name/title→label，nodes/items→children，id/point_key/object_code 兜底），保障树组件稳定渲染；保持 DEV 回退 /control/device-tree-test。
- 2025-10-06 16:20 前端联调修复：fetchDeviceTree 增强 normalize，兼容 {tree,count} / {data:{tree,count}} / {result:{tree,count}} / 数组；开发态输出 shape 调试日志，确保设备树可渲染。
- 2025-10-06 16:00 前端联调修复：标准化 /control/device-tree 返回结构为 {tree,count}，App.vue 增加容错（支持数组与对象），开发态空/异常回退 /control/device-tree-test。
- 2025-10-06 16:40, frontend/src/vite-env.d.ts, 新增 Vite 类型声明修复 import.meta.env TS 编译错误
- 2025-10-06 16:35, frontend/src/api/control.ts, 开发态对设备树增加回退至 /control/device-tree-test 的容错，保证联调可视数据
- 2025-10-06 16:00, frontend/src/api/control.ts, 将 axios baseURL 改为相对路径以命中 Vite 代理，消除联调跨域
- 2025-09-29 11:00, 说明文档.md, 初始化说明文档，补齐四大区块并登记里程碑
- 2025-09-29 11:00, .python-version, 环境锁定为 3.10.11
- 2025-09-29 11:00, .prettierrc, 统一前端格式化规则
- 2025-09-29 11:00, docs/openapi/control-module.yaml, 新增设备控制模块 OpenAPI 草案
- 2025-09-29 11:05, test_control_module.py, 新增单测骨架（OpenAPI存在性通过、两路由契约 xfail），符合 2S 流程
- 2025-09-29 11:15, main.py, 新增控制模块路由（GET /control/points/real-time、POST /control/points/write），并发/校验/重试/错误处理
- 2025-09-29 11:20, test_control_module.py, 修复转义导致的 SyntaxError，恢复标准引号与三引号
- 2025-09-29 13:10, db_config.py, 新增审计表DDL/insert函数（operation_log），提供 ensure_operation_log_table/insert_operation_log
- 2025-09-29 13:10, main.py, 集成操作审计：读取 X-Operator-Id，查询与写值均落库（ok/failed/query）
- 2025-09-29 13:20, db_config.py, 为 operation_log 增加复合索引 (operator_id, created_at)
- 2025-09-29 13:20, main.py, 写值前补充实时查询获取 before_value，并与 after_value 一并落库
- 2025-09-29 14:10, requirements.txt, 锁定 httpx==0.27.0 修复 Starlette TestClient 兼容性（解决 Client.__init__() 'app' 参数报错）
- 2025-09-29 14:10, test_control_module.py, 去除 xfail 并使用 monkeypatch 模拟下游与注入 HK_PLATFORM_TOKEN，稳定契约测试
- 2025-09-29 14:20, frontend/src/App.vue, 新增“设备总览”Tab（将设备页纳入 Tabs 框架，保持既有功能不变）
- 2025-09-29 14:30, frontend/vite.config.js, 增加 '/control' 开发代理至 http://localhost:8000，消除联调跨域
- 2025-09-29 14:40, requirements.txt / 运行环境, 安装 python-dotenv 并使用 uvicorn --env-file .env 加载 HK_PLATFORM_TOKEN 以完成联调
- 2025-09-29 14:45, main.py, 内置 load_dotenv() 自动加载 .env，uvicorn 改为常规启动（--env-file 非必需）