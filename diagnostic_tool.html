<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端状态同步诊断工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background-color: #67C23A; }
        .status-warning { background-color: #E6A23C; }
        .status-error { background-color: #F56C6C; }
        .button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button.danger {
            background: #F56C6C;
        }
        .log-area {
            background: #f8f8f8;
            border: 1px solid #ddd;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .diagnostic-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #409EFF;
            background: #f0f9ff;
        }
        .diagnostic-item.warning {
            border-left-color: #E6A23C;
            background: #fdf6ec;
        }
        .diagnostic-item.error {
            border-left-color: #F56C6C;
            background: #fef0f0;
        }
    </style>
</head>
<body>
    <div class="diagnostic-panel">
        <h1>🔧 前端状态同步诊断工具</h1>
        <p>此工具用于诊断和修复前端导出状态不同步的问题</p>
        
        <div class="diagnostic-panel">
            <h3>📊 系统状态检查</h3>
            <div id="statusChecks"></div>
            <button class="button" onclick="runDiagnostics()">🔍 运行完整诊断</button>
            <button class="button danger" onclick="forceResetAll()">🚨 强制重置所有状态</button>
        </div>
        
        <div class="diagnostic-panel">
            <h3>🔗 网络连接测试</h3>
            <button class="button" onclick="testNetworkConnection()">测试网络连接</button>
            <button class="button" onclick="testBackendAPI()">测试后端API</button>
            <button class="button" onclick="performExportTest()">执行导出测试</button>
            <div id="networkResults"></div>
        </div>
        
        <div class="diagnostic-panel">
            <h3>📋 诊断日志</h3>
            <div class="log-area" id="diagnosticLog"></div>
            <button class="button" onclick="clearLog()">清空日志</button>
            <button class="button" onclick="exportDiagnosticReport()">导出诊断报告</button>
        </div>
    </div>

    <script>
        let diagnosticLog = [];
        
        function addDiagnosticLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLog.push({time: timestamp, message, type});
            
            const logArea = document.getElementById('diagnosticLog');
            const logDiv = document.createElement('div');
            logDiv.textContent = logEntry;
            if (type === 'error') {
                logDiv.style.color = '#F56C6C';
            } else if (type === 'warning') {
                logDiv.style.color = '#E6A23C';
            } else if (type === 'success') {
                logDiv.style.color = '#67C23A';
            }
            logArea.appendChild(logDiv);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('diagnosticLog').innerHTML = '';
            diagnosticLog = [];
        }
        
        async function runDiagnostics() {
            addDiagnosticLog('🔍 开始运行完整系统诊断...', 'info');
            
            // 检查浏览器环境
            addDiagnosticLog(`浏览器: ${navigator.userAgent}`, 'info');
            addDiagnosticLog(`支持Fetch API: ${window.fetch ? '✅' : '❌'}`, window.fetch ? 'success' : 'error');
            addDiagnosticLog(`支持Promise: ${window.Promise ? '✅' : '❌'}`, window.Promise ? 'success' : 'error');
            
            // 检查localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                addDiagnosticLog('本地存储: ✅ 正常', 'success');
            } catch (e) {
                addDiagnosticLog('本地存储: ❌ 异常', 'error');
            }
            
            // 检查网络连接
            if (navigator.onLine) {
                addDiagnosticLog('网络状态: ✅ 在线', 'success');
            } else {
                addDiagnosticLog('网络状态: ❌ 离线', 'error');
            }
            
            // 检查前端服务
            try {
                const frontendResponse = await fetch(window.location.origin);
                if (frontendResponse.ok) {
                    addDiagnosticLog('前端服务: ✅ 正常', 'success');
                } else {
                    addDiagnosticLog(`前端服务: ⚠️ 响应异常 (${frontendResponse.status})`, 'warning');
                }
            } catch (e) {
                addDiagnosticLog(`前端服务: ❌ 无法连接 (${e.message})`, 'error');
            }
            
            // 检查后端服务
            try {
                const backendResponse = await fetch('http://localhost:8000/api/lines');
                if (backendResponse.ok) {
                    addDiagnosticLog('后端服务: ✅ 正常', 'success');
                } else {
                    addDiagnosticLog(`后端服务: ⚠️ 响应异常 (${backendResponse.status})`, 'warning');
                }
            } catch (e) {
                addDiagnosticLog(`后端服务: ❌ 无法连接 (${e.message})`, 'error');
            }
            
            addDiagnosticLog('🎯 诊断完成', 'success');
        }
        
        async function testNetworkConnection() {
            addDiagnosticLog('🌐 测试网络连接...', 'info');
            
            const testUrls = [
                { name: '前端服务', url: window.location.origin },
                { name: '后端API服务', url: 'http://localhost:8000' },
                { name: '线路API', url: 'http://localhost:8000/api/lines' }
            ];
            
            for (const test of testUrls) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(test.url, { 
                        method: 'GET',
                        timeout: 5000 
                    });
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    if (response.ok) {
                        addDiagnosticLog(`${test.name}: ✅ 正常 (${duration}ms)`, 'success');
                    } else {
                        addDiagnosticLog(`${test.name}: ⚠️ 状态码 ${response.status} (${duration}ms)`, 'warning');
                    }
                } catch (e) {
                    addDiagnosticLog(`${test.name}: ❌ 连接失败 (${e.message})`, 'error');
                }
            }
        }
        
        async function testBackendAPI() {
            addDiagnosticLog('🔧 测试后端API功能...', 'info');
            
            try {
                // 测试获取线路列表
                const linesResponse = await fetch('http://localhost:8000/api/lines');
                if (linesResponse.ok) {
                    const linesData = await linesResponse.json();
                    addDiagnosticLog(`线路API: ✅ 成功，获取到 ${linesData.lines?.length || 0} 条线路`, 'success');
                } else {
                    addDiagnosticLog(`线路API: ❌ 失败，状态码 ${linesResponse.status}`, 'error');
                }
            } catch (e) {
                addDiagnosticLog(`线路API: ❌ 请求异常 (${e.message})`, 'error');
            }
        }
        
        async function performExportTest() {
            addDiagnosticLog('🚀 执行导出功能测试...', 'info');
            
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            
            const exportData = {
                line: 'M11',
                start_time: oneHourAgo.toISOString().slice(0, 19).replace('T', ' '),
                end_time: now.toISOString().slice(0, 19).replace('T', ' ')
            };
            
            addDiagnosticLog(`导出参数: ${JSON.stringify(exportData)}`, 'info');
            
            try {
                addDiagnosticLog('📡 发送导出请求...', 'info');
                const startTime = Date.now();
                
                const response = await fetch('http://localhost:8000/api/export/electricity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exportData)
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addDiagnosticLog(`⏱️ 请求耗时: ${duration}ms`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    addDiagnosticLog('✅ 导出测试成功！', 'success');
                    addDiagnosticLog(`📊 结果: 总计${result.details?.total || 0}个站点，成功${result.details?.success_count || 0}个，失败${result.details?.fail_count || 0}个`, 'info');
                    
                    if (result.details?.results) {
                        result.details.results.forEach(station => {
                            const status = station.success ? '✅' : '❌';
                            addDiagnosticLog(`${status} ${station.station_name}: ${station.message}`, station.success ? 'success' : 'warning');
                        });
                    }
                } else {
                    addDiagnosticLog(`❌ 导出测试失败，状态码: ${response.status}`, 'error');
                    const errorText = await response.text();
                    addDiagnosticLog(`错误详情: ${errorText}`, 'error');
                }
            } catch (e) {
                addDiagnosticLog(`❌ 导出测试异常: ${e.message}`, 'error');
                
                if (e.name === 'AbortError') {
                    addDiagnosticLog('⚠️ 这可能是导致前端状态同步问题的原因：请求被中止', 'warning');
                } else if (e.message.includes('timeout')) {
                    addDiagnosticLog('⚠️ 这可能是导致前端状态同步问题的原因：请求超时', 'warning');
                }
            }
        }
        
        function forceResetAll() {
            addDiagnosticLog('🚨 执行强制重置...', 'warning');
            
            // 清除可能的本地状态
            try {
                localStorage.clear();
                sessionStorage.clear();
                addDiagnosticLog('✅ 已清除本地存储', 'success');
            } catch (e) {
                addDiagnosticLog(`⚠️ 清除本地存储失败: ${e.message}`, 'warning');
            }
            
            // 提示用户刷新页面
            addDiagnosticLog('🔄 建议刷新主应用页面以重置Vue组件状态', 'info');
            
            setTimeout(() => {
                if (confirm('是否要自动刷新主应用页面？这将重置所有前端状态。')) {
                    // 在新标签页中打开主应用
                    window.open('http://localhost:3000', '_blank');
                }
            }, 1000);
        }
        
        function exportDiagnosticReport() {
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                logs: diagnosticLog
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-report-${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addDiagnosticLog('📄 诊断报告已导出', 'success');
        }
        
        // 页面加载时自动运行基础诊断
        window.addEventListener('load', () => {
            addDiagnosticLog('🔧 诊断工具已启动', 'success');
            addDiagnosticLog('💡 提示：如果主应用导出按钮卡住，请点击"强制重置所有状态"', 'info');
        });
    </script>
</body>
</html>