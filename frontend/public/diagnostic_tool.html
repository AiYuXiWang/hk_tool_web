<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯çŠ¶æ€åŒæ­¥è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .diagnostic-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background-color: #67C23A; }
        .status-warning { background-color: #E6A23C; }
        .status-error { background-color: #F56C6C; }
        .button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button.danger {
            background: #F56C6C;
        }
        .log-area {
            background: #f8f8f8;
            border: 1px solid #ddd;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .diagnostic-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #409EFF;
            background: #f0f9ff;
        }
        .diagnostic-item.warning {
            border-left-color: #E6A23C;
            background: #fdf6ec;
        }
        .diagnostic-item.error {
            border-left-color: #F56C6C;
            background: #fef0f0;
        }
    </style>
</head>
<body>
    <div class="diagnostic-panel">
        <h1>ğŸ”§ å‰ç«¯çŠ¶æ€åŒæ­¥è¯Šæ–­å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨äºè¯Šæ–­å’Œä¿®å¤å‰ç«¯å¯¼å‡ºçŠ¶æ€ä¸åŒæ­¥çš„é—®é¢˜</p>
        
        <div class="diagnostic-panel">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
            <div id="statusChecks"></div>
            <button class="button" onclick="runDiagnostics()">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="button danger" onclick="forceResetAll()">ğŸš¨ å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€</button>
        </div>
        
        <div class="diagnostic-panel">
            <h3>ğŸ”— ç½‘ç»œè¿æ¥æµ‹è¯•</h3>
            <button class="button" onclick="testNetworkConnection()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
            <button class="button" onclick="testBackendAPI()">æµ‹è¯•åç«¯API</button>
            <button class="button" onclick="performExportTest()">æ‰§è¡Œå¯¼å‡ºæµ‹è¯•</button>
            <div id="networkResults"></div>
        </div>
        
        <div class="diagnostic-panel">
            <h3>ğŸ“‹ è¯Šæ–­æ—¥å¿—</h3>
            <div class="log-area" id="diagnosticLog"></div>
            <button class="button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="button" onclick="exportDiagnosticReport()">å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š</button>
        </div>
    </div>

    <script>
        let diagnosticLog = [];
        
        function addDiagnosticLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            diagnosticLog.push({time: timestamp, message, type});
            
            const logArea = document.getElementById('diagnosticLog');
            const logDiv = document.createElement('div');
            logDiv.textContent = logEntry;
            if (type === 'error') {
                logDiv.style.color = '#F56C6C';
            } else if (type === 'warning') {
                logDiv.style.color = '#E6A23C';
            } else if (type === 'success') {
                logDiv.style.color = '#67C23A';
            }
            logArea.appendChild(logDiv);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('diagnosticLog').innerHTML = '';
            diagnosticLog = [];
        }
        
        async function runDiagnostics() {
            addDiagnosticLog('ğŸ” å¼€å§‹è¿è¡Œå®Œæ•´ç³»ç»Ÿè¯Šæ–­...', 'info');
            
            // æ£€æŸ¥æµè§ˆå™¨ç¯å¢ƒ
            addDiagnosticLog(`æµè§ˆå™¨: ${navigator.userAgent}`, 'info');
            addDiagnosticLog(`æ”¯æŒFetch API: ${window.fetch ? 'âœ…' : 'âŒ'}`, window.fetch ? 'success' : 'error');
            addDiagnosticLog(`æ”¯æŒPromise: ${window.Promise ? 'âœ…' : 'âŒ'}`, window.Promise ? 'success' : 'error');
            
            // æ£€æŸ¥localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                addDiagnosticLog('æœ¬åœ°å­˜å‚¨: âœ… æ­£å¸¸', 'success');
            } catch (e) {
                addDiagnosticLog('æœ¬åœ°å­˜å‚¨: âŒ å¼‚å¸¸', 'error');
            }
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            if (navigator.onLine) {
                addDiagnosticLog('ç½‘ç»œçŠ¶æ€: âœ… åœ¨çº¿', 'success');
            } else {
                addDiagnosticLog('ç½‘ç»œçŠ¶æ€: âŒ ç¦»çº¿', 'error');
            }
            
            // æ£€æŸ¥å‰ç«¯æœåŠ¡
            try {
                const frontendResponse = await fetch(window.location.origin);
                if (frontendResponse.ok) {
                    addDiagnosticLog('å‰ç«¯æœåŠ¡: âœ… æ­£å¸¸', 'success');
                } else {
                    addDiagnosticLog(`å‰ç«¯æœåŠ¡: âš ï¸ å“åº”å¼‚å¸¸ (${frontendResponse.status})`, 'warning');
                }
            } catch (e) {
                addDiagnosticLog(`å‰ç«¯æœåŠ¡: âŒ æ— æ³•è¿æ¥ (${e.message})`, 'error');
            }
            
            // æ£€æŸ¥åç«¯æœåŠ¡
            try {
                const backendResponse = await fetch('http://localhost:8000/api/lines');
                if (backendResponse.ok) {
                    addDiagnosticLog('åç«¯æœåŠ¡: âœ… æ­£å¸¸', 'success');
                } else {
                    addDiagnosticLog(`åç«¯æœåŠ¡: âš ï¸ å“åº”å¼‚å¸¸ (${backendResponse.status})`, 'warning');
                }
            } catch (e) {
                addDiagnosticLog(`åç«¯æœåŠ¡: âŒ æ— æ³•è¿æ¥ (${e.message})`, 'error');
            }
            
            addDiagnosticLog('ğŸ¯ è¯Šæ–­å®Œæˆ', 'success');
        }
        
        async function testNetworkConnection() {
            addDiagnosticLog('ğŸŒ æµ‹è¯•ç½‘ç»œè¿æ¥...', 'info');
            
            const testUrls = [
                { name: 'å‰ç«¯æœåŠ¡', url: window.location.origin },
                { name: 'åç«¯APIæœåŠ¡', url: 'http://localhost:8000' },
                { name: 'çº¿è·¯API', url: 'http://localhost:8000/api/lines' }
            ];
            
            for (const test of testUrls) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(test.url, { 
                        method: 'GET',
                        timeout: 5000 
                    });
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    if (response.ok) {
                        addDiagnosticLog(`${test.name}: âœ… æ­£å¸¸ (${duration}ms)`, 'success');
                    } else {
                        addDiagnosticLog(`${test.name}: âš ï¸ çŠ¶æ€ç  ${response.status} (${duration}ms)`, 'warning');
                    }
                } catch (e) {
                    addDiagnosticLog(`${test.name}: âŒ è¿æ¥å¤±è´¥ (${e.message})`, 'error');
                }
            }
        }
        
        async function testBackendAPI() {
            addDiagnosticLog('ğŸ”§ æµ‹è¯•åç«¯APIåŠŸèƒ½...', 'info');
            
            try {
                // æµ‹è¯•è·å–çº¿è·¯åˆ—è¡¨
                const linesResponse = await fetch('http://localhost:8000/api/lines');
                if (linesResponse.ok) {
                    const linesData = await linesResponse.json();
                    addDiagnosticLog(`çº¿è·¯API: âœ… æˆåŠŸï¼Œè·å–åˆ° ${linesData.lines?.length || 0} æ¡çº¿è·¯`, 'success');
                } else {
                    addDiagnosticLog(`çº¿è·¯API: âŒ å¤±è´¥ï¼ŒçŠ¶æ€ç  ${linesResponse.status}`, 'error');
                }
            } catch (e) {
                addDiagnosticLog(`çº¿è·¯API: âŒ è¯·æ±‚å¼‚å¸¸ (${e.message})`, 'error');
            }
        }
        
        async function performExportTest() {
            addDiagnosticLog('ğŸš€ æ‰§è¡Œå¯¼å‡ºåŠŸèƒ½æµ‹è¯•...', 'info');
            
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            
            const exportData = {
                line: 'M11',
                start_time: oneHourAgo.toISOString().slice(0, 19).replace('T', ' '),
                end_time: now.toISOString().slice(0, 19).replace('T', ' ')
            };
            
            addDiagnosticLog(`å¯¼å‡ºå‚æ•°: ${JSON.stringify(exportData)}`, 'info');
            
            try {
                addDiagnosticLog('ğŸ“¡ å‘é€å¯¼å‡ºè¯·æ±‚...', 'info');
                const startTime = Date.now();
                
                const response = await fetch('http://localhost:8000/api/export/electricity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exportData)
                });
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                addDiagnosticLog(`â±ï¸ è¯·æ±‚è€—æ—¶: ${duration}ms`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    addDiagnosticLog('âœ… å¯¼å‡ºæµ‹è¯•æˆåŠŸï¼', 'success');
                    addDiagnosticLog(`ğŸ“Š ç»“æœ: æ€»è®¡${result.details?.total || 0}ä¸ªç«™ç‚¹ï¼ŒæˆåŠŸ${result.details?.success_count || 0}ä¸ªï¼Œå¤±è´¥${result.details?.fail_count || 0}ä¸ª`, 'info');
                    
                    if (result.details?.results) {
                        result.details.results.forEach(station => {
                            const status = station.success ? 'âœ…' : 'âŒ';
                            addDiagnosticLog(`${status} ${station.station_name}: ${station.message}`, station.success ? 'success' : 'warning');
                        });
                    }
                } else {
                    addDiagnosticLog(`âŒ å¯¼å‡ºæµ‹è¯•å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`, 'error');
                    const errorText = await response.text();
                    addDiagnosticLog(`é”™è¯¯è¯¦æƒ…: ${errorText}`, 'error');
                }
            } catch (e) {
                addDiagnosticLog(`âŒ å¯¼å‡ºæµ‹è¯•å¼‚å¸¸: ${e.message}`, 'error');
                
                if (e.name === 'AbortError') {
                    addDiagnosticLog('âš ï¸ è¿™å¯èƒ½æ˜¯å¯¼è‡´å‰ç«¯çŠ¶æ€åŒæ­¥é—®é¢˜çš„åŸå› ï¼šè¯·æ±‚è¢«ä¸­æ­¢', 'warning');
                } else if (e.message.includes('timeout')) {
                    addDiagnosticLog('âš ï¸ è¿™å¯èƒ½æ˜¯å¯¼è‡´å‰ç«¯çŠ¶æ€åŒæ­¥é—®é¢˜çš„åŸå› ï¼šè¯·æ±‚è¶…æ—¶', 'warning');
                }
            }
        }
        
        function forceResetAll() {
            addDiagnosticLog('ğŸš¨ æ‰§è¡Œå¼ºåˆ¶é‡ç½®...', 'warning');
            
            // æ¸…é™¤å¯èƒ½çš„æœ¬åœ°çŠ¶æ€
            try {
                localStorage.clear();
                sessionStorage.clear();
                addDiagnosticLog('âœ… å·²æ¸…é™¤æœ¬åœ°å­˜å‚¨', 'success');
            } catch (e) {
                addDiagnosticLog(`âš ï¸ æ¸…é™¤æœ¬åœ°å­˜å‚¨å¤±è´¥: ${e.message}`, 'warning');
            }
            
            // æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
            addDiagnosticLog('ğŸ”„ å»ºè®®åˆ·æ–°ä¸»åº”ç”¨é¡µé¢ä»¥é‡ç½®Vueç»„ä»¶çŠ¶æ€', 'info');
            
            setTimeout(() => {
                if (confirm('æ˜¯å¦è¦è‡ªåŠ¨åˆ·æ–°ä¸»åº”ç”¨é¡µé¢ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰å‰ç«¯çŠ¶æ€ã€‚')) {
                    // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ä¸»åº”ç”¨
                    window.open('http://localhost:3000', '_blank');
                }
            }, 1000);
        }
        
        function exportDiagnosticReport() {
            const report = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href,
                logs: diagnosticLog
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `diagnostic-report-${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addDiagnosticLog('ğŸ“„ è¯Šæ–­æŠ¥å‘Šå·²å¯¼å‡º', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€è¯Šæ–­
        window.addEventListener('load', () => {
            addDiagnosticLog('ğŸ”§ è¯Šæ–­å·¥å…·å·²å¯åŠ¨', 'success');
            addDiagnosticLog('ğŸ’¡ æç¤ºï¼šå¦‚æœä¸»åº”ç”¨å¯¼å‡ºæŒ‰é’®å¡ä½ï¼Œè¯·ç‚¹å‡»"å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€"', 'info');
        });
    </script>
</body>
</html>