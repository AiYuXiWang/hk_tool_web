name: UIä¼˜åŒ–éƒ¨ç½²æµç¨‹

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/ui-optimization.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'

env:
  NODE_VERSION: '18'
  FRONTEND_PATH: './frontend'
  BUILD_CACHE_KEY: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_PATH }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm ci

      - name: ESLintæ£€æŸ¥
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run lint:check

      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run format:check

      - name: TypeScriptç±»å‹æ£€æŸ¥
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run type-check

      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: quality-reports
          path: |
            ${{ env.FRONTEND_PATH }}/eslint-report.html
            ${{ env.FRONTEND_PATH }}/type-check-report.txt
          retention-days: 7

  # å•å…ƒæµ‹è¯•
  unit-tests:
    runs-on: ubuntu-latest
    name: å•å…ƒæµ‹è¯•

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_PATH }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm ci

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run test:coverage

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ${{ env.FRONTEND_PATH }}/coverage/lcov.info
          flags: ui-optimization
          name: UIä¼˜åŒ–æµ‹è¯•è¦†ç›–ç‡

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: ${{ env.FRONTEND_PATH }}/coverage/
          retention-days: 7

  # ç»„ä»¶æµ‹è¯•
  component-tests:
    runs-on: ubuntu-latest
    name: ç»„ä»¶æµ‹è¯•
    needs: [quality-check]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_PATH }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run build

      - name: è¿è¡Œç»„ä»¶æµ‹è¯•
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run test:components

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    runs-on: ubuntu-latest
    name: ç«¯åˆ°ç«¯æµ‹è¯•
    needs: [unit-tests]

    services:
      # æ¨¡æ‹Ÿåç«¯æœåŠ¡
      backend:
        image: node:18-alpine
        ports:
          - 8000:8000
        options: >-
          --health-cmd "curl -f http://localhost:8000/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_PATH }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run build

      - name: å¯åŠ¨åº”ç”¨
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          npm run preview &
          sleep 10

      - name: å®‰è£…Cypress
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npx cypress install

      - name: è¿è¡ŒE2Eæµ‹è¯•
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npx cypress run --spec "cypress/e2e/ui-optimization.cy.js"

      - name: ä¸Šä¼ æµ‹è¯•è§†é¢‘
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: ${{ env.FRONTEND_PATH }}/cypress/videos/
          retention-days: 7

      - name: ä¸Šä¼ æµ‹è¯•æˆªå›¾
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: ${{ env.FRONTEND_PATH }}/cypress/screenshots/
          retention-days: 7

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    runs-on: ubuntu-latest
    name: æ€§èƒ½æµ‹è¯•
    needs: [component-tests]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_PATH }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run build

      - name: å¯åŠ¨åº”ç”¨
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          npm run preview &
          sleep 10

      - name: è¿è¡ŒLighthouseæ€§èƒ½æµ‹è¯•
        run: |
          npx @lhci/cli@0.12.x autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm run test:performance

  # æ„å»ºå’Œæ‰“åŒ…
  build:
    runs-on: ubuntu-latest
    name: æ„å»ºæ‰“åŒ…
    needs: [unit-tests, e2e-tests]

    strategy:
      matrix:
        environment: [development, staging, production]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_PATH }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm ci

      - name: æ„å»ºé¡¹ç›®
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          if [ "${{ matrix.environment }}" = "production" ]; then
            npm run build:prod
          else
            npm run build
          fi
        env:
          NODE_ENV: ${{ matrix.environment }}

      - name: å‹ç¼©æ„å»ºäº§ç‰©
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          tar -czf ui-optimization-${{ matrix.environment }}.tar.gz dist/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ui-optimization-${{ matrix.environment }}
          path: ${{ env.FRONTEND_PATH }}/ui-optimization-${{ matrix.environment }}.tar.gz
          retention-days: 30

      - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          npm run build:analyze

      - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ matrix.environment }}
          path: ${{ env.FRONTEND_PATH }}/dist-report.html
          retention-days: 7

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ‰«æ
    needs: [build]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è¿è¡Œnpmå®‰å…¨å®¡è®¡
        working-directory: ${{ env.FRONTEND_PATH }}
        run: npm audit --audit-level moderate

      - name: è¿è¡ŒSnykå®‰å…¨æ‰«æ
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
          command: monitor
          project: ${{ env.FRONTEND_PATH }}

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment: development

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ui-optimization-development
          path: ${{ env.FRONTEND_PATH }}

      - name: è§£å‹æ„å»ºäº§ç‰©
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          tar -xzf ui-optimization-development.tar.gz

      - name: éƒ¨ç½²åˆ°å¼€å‘æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USERNAME }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            cd /var/www/hk-tool-web
            docker-compose down
            rm -rf dist/
            mkdir -p dist/
            # è¿™é‡Œåº”è¯¥æ˜¯ä»ä¸Šä¼ çš„æ–‡ä»¶ä¸­å¤åˆ¶ï¼Œç®€åŒ–ç¤ºä¾‹
            docker-compose up -d

      - name: å¥åº·æ£€æŸ¥
        run: |
          sleep 30
          curl -f https://dev.hk-tool-web.com/health || exit 1

      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployment'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-prod:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ui-optimization-production
          path: ${{ env.FRONTEND_PATH }}

      - name: è§£å‹æ„å»ºäº§ç‰©
        working-directory: ${{ env.FRONTEND_PATH }}
        run: |
          tar -xzf ui-optimization-production.tar.gz

      - name: åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
        uses: actions/github-script@v7
        with:
          script: |
            const version = `v1.${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}.${process.env.GITHUB_RUN_NUMBER}`
            github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: `UIä¼˜åŒ–å‘å¸ƒ ${version}`,
              body: `## UIä¼˜åŒ–åŠŸèƒ½å‘å¸ƒ\n\n### æ–°å¢åŠŸèƒ½\n- å¢å¼ºæŒ‰é’®ç»„ä»¶\n- KPIå¡ç‰‡ç»„ä»¶å‡çº§\n- åŠ è½½éª¨æ¶å±ç»„ä»¶\n- å“åº”å¼è®¾è®¡ä¼˜åŒ–\n\n### æ”¹è¿›\n- äº¤äº’ä½“éªŒä¼˜åŒ–\n- æ€§èƒ½æå‡\n- æ— éšœç¢æ”¯æŒ\n\n### æŠ€æœ¯å€ºåŠ¡\n- ä»£ç é‡æ„\n- æµ‹è¯•è¦†ç›–ç‡æå‡`,
              draft: false,
              prerelease: false
            })

      - name: è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /var/www/hk-tool-web
            # å¥åº·æ£€æŸ¥å½“å‰ç‰ˆæœ¬
            curl -f https://hk-tool-web.com/health || exit 1

            # è“ç»¿éƒ¨ç½²
            docker-compose -f docker-compose.blue.yml up -d
            sleep 60

            # å¥åº·æ£€æŸ¥æ–°ç‰ˆæœ¬
            curl -f https://blue.hk-tool-web.com/health || exit 1

            # åˆ‡æ¢æµé‡
            docker-compose -f docker-compose.switch.yml up
            sleep 30

            # æ¸…ç†æ—§ç‰ˆæœ¬
            docker-compose -f docker-compose.green.yml down

      - name: ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
        run: |
          sleep 60
          curl -f https://hk-tool-web.com/health || exit 1
          curl -f https://hk-tool-web.com/api/health || exit 1

      - name: æ€§èƒ½ç›‘æ§
        run: |
          # ä½¿ç”¨Lighthouse CIæ£€æŸ¥ç”Ÿäº§ç¯å¢ƒæ€§èƒ½
          npx @lhci/cli@0.12.x autorun --config=.lighthouserc-prod.js

      - name: é€šçŸ¥å‘å¸ƒç»“æœ
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployment'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            ğŸš€ UIä¼˜åŒ–åŠŸèƒ½å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼

            ğŸ“Š å‘å¸ƒä¿¡æ¯ï¼š
            - ç‰ˆæœ¬ï¼šv1.${{ github.run_number }}
            - æäº¤ï¼š${{ github.sha }}
            - åˆ†æ”¯ï¼š${{ github.ref_name }}

            ğŸ”— è®¿é—®é“¾æ¥ï¼šhttps://hk-tool-web.com
        if: always()

  # å›æ»šä»»åŠ¡
  rollback:
    runs-on: ubuntu-latest
    name: ç´§æ€¥å›æ»š
    needs: [deploy-prod]
    if: failure() && github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: ç´§æ€¥å›æ»š
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /var/www/hk-tool-web
            # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
            docker-compose rollback
            sleep 30
            curl -f https://hk-tool-web.com/health || exit 1

      - name: é€šçŸ¥å›æ»š
        uses: 8398a7/action-slack@v3
        with:
          status: 'failure'
          channel: '#deployment'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            ğŸš¨ ç”Ÿäº§ç¯å¢ƒå·²ç´§æ€¥å›æ»šï¼

            è¯·ç«‹å³æ£€æŸ¥å¹¶ä¿®å¤é—®é¢˜ã€‚
        if: always()